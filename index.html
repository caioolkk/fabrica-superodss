<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fábrica Super Odd — Calculadora</title>
  <link rel="icon" href="image/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1f2b3a;
      --accent: #f3e5a6;
      --accent-strong: #e9d984;
      --muted: #6b7280;
      --card: #ffffff;
      --soft: #f5f7fa;
      --shadow: 0 6px 20px rgba(18, 24, 36, 0.06);
      --watermark-opacity: 0.04;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    }
    html,
    body {
      height: 100%;
      background: #f6f7fb;
      color: #111;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden; /* 🔒 BLOQUEIA ROLAGEM HORIZONTAL */
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    * {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    *::-webkit-scrollbar {
      display: none;
    }
    .wrap {
      width: 100%;
      max-width: 1150px;
      margin: 16px auto;
      padding: 0 12px;
    }
    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card);
      padding: 12px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      gap: 10px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }
    .logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: url('image/logo.png') center/contain no-repeat;
      flex-shrink: 0;
    }
    .brand h1 {
      font-size: 15px;
      font-weight: 700;
      color: #0f1724;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .small {
      font-size: 12px;
      color: var(--muted);
    }
    .nav-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .nav-actions button,
    .nav-actions a {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    .section {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .section::before,
    .table-wrap::before,
    .results-left::before,
    .summary-card::before {
      content: '';
      position: absolute;
      right: 12px;
      bottom: 6px;
      width: 140px;
      height: 140px;
      background-image: url('image/logo.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: var(--watermark-opacity);
      pointer-events: none;
      filter: grayscale(1);
      mix-blend-mode: lighten;
    }
    .table-wrap::before,
    .results-left::before {
      inset: 0;
      background-size: 200px;
      background-repeat: repeat;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 12px;
      color: #0b1720;
      background: var(--card);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      margin: -16px -16px 12px;
    }
    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px;
    }
    .grid2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    label {
      font-size: 14px;
      color: #24303a;
      font-weight: 600;
    }
    select,
    input[type="number"],
    input[type="text"] {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #e6f0e9;
      background: #fff;
      outline: none;
      font-size: 14px;
      width: 100%;
    }
    .toggles {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 14px;
    }
    .toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .toggle .small {
      white-space: nowrap;
    }
    .switch {
      position: relative;
      width: 40px;
      height: 24px;
      border-radius: 14px;
      background: #eee;
      cursor: pointer;
    }
    .switch input {
      display: none;
    }
    .knob {
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      transition: all .22s;
    }
    .switch.on {
      background: var(--accent-strong);
    }
    .switch.on .knob {
      transform: translateX(16px);
    }
    .toggle-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.4;
    }
    .table-wrap {
      margin-top: 6px;
      border-radius: 10px;
      overflow: auto;
      position: relative;
      width: 100%;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      min-width: 600px;
    }
    thead th {
      background: var(--primary);
      color: #fff;
      padding: 10px 6px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      font-weight: 700;
      text-align: left;
      font-size: 12px;
      white-space: nowrap;
    }
    tbody tr {
      background: #f6f7f9;
    }
    tbody tr + tr {
      margin-top: 6px;
    }
    tbody td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(16, 24, 32, 0.04);
      vertical-align: middle;
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .col-casa { width: 16%; }
    .col-tipo { width: 8%; }
    .col-odd { width: 7%; }
    .col-comissao { width: 9%; }
    .col-oddfinal { width: 9%; }
    .col-aumento { width: 8%; }
    .col-aposta { width: 14%; }
    .col-freebet { width: 10%; }
    .col-cashback { width: 10%; }
    .col-c { width: 7%; }
    .col-lucro { width: 12%; }
    tbody td input[type="text"],
    tbody td input[type="number"] {
      border: 1px solid #dfe7d0;
      padding: 6px 8px; /* ↑ aumentado */
      border-radius: 6px;
      background: #fff;
      font-size: 13px;
      width: 100%;
      box-sizing: border-box;
    }
    .type-btn {
      display: inline-block;
      padding: 6px 10px; /* ↑ aumentado */
      border-radius: 6px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      border: none;
      width: 100%;
      text-align: center;
    }
    .type-btn.back {
      background: rgba(0, 0, 0, 0.05);
      color: #0f1724;
    }
    .type-btn.lay {
      background: rgba(255, 0, 0, 0.08);
      color: #8b1f1f;
    }
    .chk {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    .chk input {
      display: none;
    }
    .chk .chkbox {
      width: 20px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #ddd;
      display: inline-block;
      position: relative;
      transition: all .18s;
      background: #fff;
    }
    .chk .chkbox::after {
      content: '';
      position: absolute;
      left: 5px;
      top: 0;
      width: 5px;
      height: 9px;
      border: solid #fff;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      opacity: 0;
      transition: opacity .14s;
    }
    .chk input:checked + .chkbox {
      background: var(--accent);
      border-color: var(--accent-strong);
    }
    .chk input:checked + .chkbox::after {
      opacity: 1;
    }
    .col-freebet.hidden,
    .col-cashback.hidden,
    .col-comissao.hidden,
    .col-aumento.hidden {
      display: none !important;
    }
    .results-wrap {
      margin-top: 12px;
      display: flex;
      gap: 16px;
      flex-direction: column;
    }
    @media (min-width: 769px) {
      .results-wrap {
        flex-direction: row;
      }
    }
    .results-left {
      flex: 1 1 600px;
      min-width: 300px;
      border-radius: 10px;
      overflow: hidden;
      background: var(--card);
      border: 1px solid #e9eef0;
      position: relative;
    }
    .results-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .results-table thead th {
      background: var(--primary);
      color: #fff;
      padding: 10px;
      font-weight: 700;
      text-align: left;
      font-size: 13px;
    }
    .results-table td {
      padding: 10px;
      border-bottom: 1px solid rgba(16, 24, 32, 0.04);
      background: #fff;
      font-size: 14px;
    }
    .results-right {
      width: 100%;
      max-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .results-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .results-actions .btn {
      width: 100%;
      display: block;
      text-align: center;
    }
    .summary-cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .summary-card {
      background: var(--card);
      border-radius: 10px;
      padding: 14px;
      border: 1px solid #eef6f8;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .summary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }
    .summary-card .label {
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }
    .summary-card .value {
      font-weight: 800;
      margin-top: 6px;
      font-size: 16px;
      color: var(--primary);
    }
    .summary-card .value.highlight {
      color: var(--accent);
    }
    .btn {
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .btn.ghost {
      background: transparent;
      border: 1px solid #e6e9ee;
      color: var(--muted);
    }

    /* ===== ✅ MOBILE: LAYOUT VERTICAL (SEM FLEX ENTRE LABEL E INPUT) ===== */
    @media (max-width: 768px) {
      /* Garantir que nada extrapole */
      body, .wrap, .section, .table-wrap {
        overflow-x: hidden;
      }

      /* Tabela vira lista de cards */
      #apostasTable {
        display: block;
        width: 100%;
      }
      #apostasTable thead {
        display: none;
      }
      #apostasTable tbody {
        display: block;
        width: 100%;
      }
      #apostasTable tr {
        display: block;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      }
      #apostasTable td {
        display: block;
        padding: 8px 0;
        border: none;
        font-size: 14px;
        width: 100%;
      }
      #apostasTable td::before {
        content: attr(data-label);
        display: block;
        font-weight: 600;
        color: #1f2937;
        font-size: 13px;
        margin-bottom: 6px; /* ↑ espaço maior */
      }
      /* Inputs maiores */
      #apostasTable input[type="text"],
      #apostasTable input[type="number"] {
        width: 100%;
        padding: 10px; /* ↑ aumentado */
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 14px;
        background: #fff;
        box-sizing: border-box;
      }
      /* Botões BACK/LAY */
      #apostasTable .type-btn {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        text-align: center;
        border-radius: 8px;
      }
      /* Checkboxes */
      #apostasTable .chk {
        display: flex;
        align-items: center;
        gap: 10px;
        justify-content: flex-start;
      }
      /* Rodapé */
      #apostasTable tfoot {
        display: block;
        margin-top: 14px;
      }
      #apostasTable tfoot tr {
        display: block;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 14px;
      }
      #apostasTable tfoot td {
        display: block;
        padding: 8px 0;
      }
      .aposta-total {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .aposta-total input {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        border-radius: 8px;
      }
      #btnCopyAposta {
        width: 100%;
        padding: 10px;
        font-size: 14px;
        border-radius: 8px;
      }

      /* Resultados empilhados */
      .results-wrap {
        flex-direction: column;
      }
      .results-right {
        max-width: none;
      }
      .summary-cards {
        grid-template-columns: 1fr;
      }
    }

    #modal {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
}

.results-wrap {
  display: flex;
  gap: 16px;
  flex-direction: column;
}

@media (min-width: 769px) {
  .results-wrap {
    flex-direction: row;
  }
}

.results-left {
  flex: 1;
  background: var(--card);
  border-radius: 12px;
  padding: 16px;
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
}

.results-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  table-layout: fixed;
  min-width: 100%;
}

.results-table thead {
  background: var(--primary);
  color: #fff;
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
}

.results-table th {
  padding: 10px 6px;
  font-weight: 700;
  text-align: left;
  font-size: 12px;
  white-space: nowrap;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.results-table tbody tr {
  background: #f6f7f9;
  transition: background 0.2s ease;
}

.results-table tbody tr:hover {
  background: #e9ecef;
}

.results-table tbody td {
  padding: 8px 6px;
  border-bottom: 1px solid rgba(16, 24, 32, 0.04);
  vertical-align: middle;
  font-size: 13px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.results-table tbody td:last-child {
  text-align: right;
  font-weight: 600;
}

.results-table tbody td:nth-child(5) {
  color: #22bb33;
}

.results-right {
  display: flex;
  flex-direction: column;
  gap: 16px;
  min-width: 280px;
}

.results-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.btn {
  display: inline-block;
  background: var(--primary);
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  white-space: nowrap;
  text-align: center;
  transition: all 0.2s ease;
}

.btn:hover {
  background: #1a2330;
  transform: translateY(-1px);
}

.btn.ghost {
  background: transparent;
  color: var(--primary);
  border: 1px solid var(--primary);
}

.btn.ghost:hover {
  background: var(--primary);
  color: #fff;
}

.summary-cards {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.summary-card {
  background: var(--soft);
  border-radius: 10px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
  position: relative;
  overflow: hidden;
}

.summary-card .label {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 6px;
  font-weight: 500;
}

.summary-card .value {
  font-size: 16px;
  font-weight: 700;
  color: #0b1720;
}

.summary-card .value.highlight {
  color: var(--accent-strong);
  font-size: 18px;
}

.aposta-total {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 8px;
  width: 100%;
  box-sizing: border-box;
}

@media (max-width: 600px) {
  .aposta-total {
    flex-direction: column;
    gap: 6px;
    padding: 0 8px;
  }

  .aposta-total input,
  .aposta-total button {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }

  .aposta-foot {
    overflow-x: hidden;
  }
}



  #apostasTable { min-width: 0 !important; table-layout: auto !important; }

  #apostasTable td {
    padding: 10px 12px !important;
    word-break: break-word;
    white-space: normal;
  }

  #apostasTable td::before { white-space: normal; }

  #apostasTable input[type="text"],
  #apostasTable input[type="number"],
  #apostasTable .type-btn,
  .aposta-total input,
  .aposta-total button,
  .results-right .btn,
  .btn {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  .aposta-total,
  .aposta-foot {
    overflow: hidden;
    padding: 8px 12px;
  }

  #btnCopyAposta {
    display: inline-block;
    padding: 10px 12px !important;
    border-radius: 8px !important;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .results-actions .btn,
  .results-right .btn {
    display: block;
    width: 100%;
  }

  .brand, .nav-actions, .grid2, .results-wrap, .results-right, .summary-cards {
    min-width: 0;
  }

@media (max-width:768px){
  .table-wrap::before, .results-left::before { display:none!important; }
}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="navbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Fábrica Super Odd</h1>
          <div class="small">Calculadora de Arbitragem</div>
          <div><a href="./planilha.html" class="irplanilha" style="color: #e9d984;"><h3>Planilha</h3></a></div>
        </div>
      </div>
      <div class="nav-actions">
        <a href="#" id="btnOpenLogin" title="Entrar / Sair"
          style="background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;text-decoration:none;display:inline-block">Entrar</a>
      </div>
    </div>

    <div class="section">
      <h2>Configurações</h2>
      <div class="sub">Defina o procedimento e as opções.</div>
      <div class="grid2">
        <div class="field">
          <label>Quantidade de casas</label>
          <select id="qtdCasas" disabled>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
        </div>
        <div class="field">
          <label>Quantidade de contas</label>
          <input id="qtdContas" type="number" min="1" value="1" disabled>
          <div class="small">Multiplica stake e lucro final</div>
        </div>
      </div>
      <div class="toggles">
        <div class="toggle" title="Ativa coluna 'Freebet'">
          <div id="switchFreebet" class="switch">
            <div class="knob"></div>
          </div>
          <div class="small">Usar Freebet</div>
        </div>
        <div class="toggle" title="Ativa coluna 'Cashback'">
          <div id="switchCashback" class="switch">
            <div class="knob"></div>
          </div>
          <div class="small">Usar Cashback</div>
        </div>
        <div class="toggle" title="Exibir comissão">
          <div id="switchComissao" class="switch on">
            <div class="knob"></div>
          </div>
          <div class="small">Exibir comissão</div>
        </div>
        <div class="toggle" title="Exibir aumento">
          <div id="switchAumento" class="switch">
            <div class="knob"></div>
          </div>
          <div class="small">Exibir aumento</div>
        </div>
      </div>
      <div class="toggle-note">
        • <strong>Freebet</strong>: aposta grátis.<br>
        • <strong>Cashback</strong>: recupera % em caso de perda.
      </div>
    </div>

    <div class="section">
      <h2>Linhas de Apostas</h2>
      <div class="sub">Insira odds e o sistema distribuirá automaticamente.</div>
      <div class="table-wrap">
        <table id="apostasTable" aria-label="Linhas de apostas">
          <thead>
            <tr>
              <th class="col-casa">Casa</th>
              <th class="col-tipo">Tipo</th>
              <th class="col-odd">ODD</th>
              <th class="col-comissao">Comissão %</th>
              <th class="col-oddfinal">ODD Final</th>
              <th class="col-aumento">Aumento %</th>
              <th class="col-aposta">Aposta</th>
              <th class="col-freebet">Freebet</th>
              <th class="col-cashback">Cashback %</th>
              <th class="col-c">C</th>
              <th class="col-lucro">Lucro</th>
            </tr>
          </thead>
          <tbody id="apostasBody"></tbody>
          <tfoot>
            <tr>
              <td colspan="6"></td>
              <td colspan="1" class="aposta-foot">
                <div class="aposta-total">
                  <strong>Aposta total:</strong>
                  <input id="apostaTotalDisplay" type="number" step="0.01" value="100.00">
                  <button class="btn ghost" id="btnCopyAposta" disabled>📋 Copiar</button>
                </div>
              </td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Resultados</h2>
      <div class="results-wrap">
        <div class="results-left">
          <table class="results-table">
            <thead>
              <tr>
                <th>Casa</th>
                <th>ODD</th>
                <th>Aposta</th>
                <th>Tipo</th>
                <th>Lucro</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
        <div class="results-right">
          <div class="results-actions">
            <button class="btn" id="btnShare" disabled>📤 Compartilhar</button>
            <button class="btn ghost" id="btnAddPlanilha" disabled>📊 Adicionar à planilha</button>
          </div>
          <div class="summary-cards">
            <div class="summary-card">
              <div class="label">Stake Total</div>
              <div class="value highlight" id="stakeTotal">R$ 0.00</div>
            </div>
            <div class="summary-card">
              <div class="label">Porcentagem</div>
              <div class="value" id="porcentagem">0.00 %</div>
            </div>
            <div class="summary-card">
              <div class="label">Lucro (pior cenário)</div>
              <div class="value highlight" id="lucroTotal">R$ 0.00</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="adminPanel" class="section" style="display:none"></div>
  </div>

  <!-- Modal de Login -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <h3 id="modalTitle">Entrar</h3>
      <div class="muted">Use seu e-mail e senha.</div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn" id="btnModalLogin">Login</button>
        <button class="btn ghost" id="btnModalRegister">Cadastrar</button>
      </div>
      <div style="margin-top:8px"><label>Email</label><input id="authEmail" type="text" placeholder="seu@email.com"></div>
      <div style="margin-top:8px"><label>Senha</label><input id="authPass" type="password" placeholder="senha"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="btnDoAuth">Confirmar</button>
        <button class="btn ghost" id="btnCloseModal">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    const state = {
      qtdCasas: 2,
      showComissao: true,
      showAumento: false,
      showFreebet: false,
      showCashback: false,
      controlIndex: null,
      manualMode: false
    };
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const money = v => "R$ " + (Number(v || 0).toFixed(2));

    function isLoggedIn() {
      return localStorage.getItem('superodd_logged_in') === 'true';
    }

    function updateNavbar() {
      const btn = $('#btnOpenLogin');
      if (!btn) return;
      if (isLoggedIn()) {
        btn.textContent = 'Sair';
        btn.onclick = e => {
          e.preventDefault();
          localStorage.removeItem('superodd_logged_in');
          location.reload();
        };
      } else {
        btn.textContent = 'Entrar';
        btn.onclick = e => {
          e.preventDefault();
          $('#modal').style.display = 'flex';
        };
      }
    }

    function updateInputsState() {
      const logged = isLoggedIn();
      const disable = !logged;
      ['#qtdCasas', '#qtdContas', '#btnCopyAposta', '#btnShare', '#btnAddPlanilha', '#apostaTotalDisplay']
        .forEach(sel => { const el = $(sel); if (el) el.disabled = disable; });
      $$('#apostasBody input, #apostasBody button, .chk input').forEach(el => el.disabled = disable);
    }

    function createRow(i) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="col-casa" data-label="Casa">
          <input class="casa-input" type="text" value="Casa ${i + 1}">
        </td>
        <td class="col-tipo" data-label="Tipo">
          <button class="type-btn back">BACK</button>
        </td>
        <td class="col-odd" data-label="ODD">
          <input class="odd-input" type="number" step="0.001" min="1.001" value="2.000">
        </td>
        <td class="col-comissao" data-label="Comissão %">
          <input class="comissao-input" type="number" step="0.01" min="0" value="0.00">
        </td>
        <td class="col-oddfinal" data-label="ODD Final">
          <span class="odd-final">2.000</span>
        </td>
        <td class="col-aumento" data-label="Aumento %">
          <input class="aumento-input" type="number" step="0.01" min="0" value="0.00">
        </td>
        <td class="col-aposta" data-label="Aposta">
          <input class="aposta-input" type="text" value="0,00">
        </td>
        <td class="col-freebet" data-label="Freebet">
          <label class="chk"><input class="freebet-checkbox" type="checkbox"><span class="chkbox"></span></label>
        </td>
        <td class="col-cashback" data-label="Cashback %">
          <input class="cashback-input" type="number" step="0.01" min="0" value="0.00">
        </td>
        <td class="col-c" data-label="Travar">
          <label class="chk"><input class="comissao-checkbox" type="checkbox"><span class="chkbox"></span></label>
        </td>
        <td class="col-lucro" data-label="Lucro">
          <span class="lucro-output">0.00</span>
        </td>
      `;
      tr.querySelectorAll('.odd-input, .aposta-input').forEach(inp => {
        inp.addEventListener('focus', () => inp.select());
      });
      tr.querySelector('.type-btn').addEventListener('click', e => {
        if (!isLoggedIn()) return;
        const btn = e.target;
        btn.classList.toggle('lay');
        btn.classList.toggle('back');
        btn.textContent = btn.classList.contains('lay') ? 'LAY' : 'BACK';
        updateCalculations();
      });
      tr.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', () => {
          if (!isLoggedIn()) return;
          if (inp.classList.contains('aposta-input')) {
            state.manualMode = true;
            state.controlIndex = null;
            $$('.comissao-checkbox').forEach(c => c.checked = false);
            recalcApostaTotal();
          }
          updateCalculations();
        });
      });
      tr.querySelector('.comissao-checkbox').addEventListener('change', e => {
        if (!isLoggedIn()) return;
        const cb = e.target;
        $$('.comissao-checkbox').forEach(x => { if (x !== cb) x.checked = false; });
        state.controlIndex = cb.checked ? [...$('#apostasBody').children].indexOf(tr) : null;
        state.manualMode = false;
        updateCalculations();
      });
      tr.querySelector('.freebet-checkbox').addEventListener('change', () => {
        if (!isLoggedIn()) return;
        recalcApostaTotal();
        updateCalculations();
      });
      return tr;
    }

    function renderRows() {
      const tbody = $('#apostasBody');
      tbody.innerHTML = '';
      for (let i = 0; i < state.qtdCasas; i++) tbody.appendChild(createRow(i));
      renderTableColumns();
      updateInputsState();
    }

    function renderTableColumns() {
      const map = {
        '.col-freebet': state.showFreebet,
        '.col-cashback': state.showCashback,
        '.col-comissao': state.showComissao,
        '.col-aumento': state.showAumento
      };
      Object.entries(map).forEach(([sel, visible]) => {
        $$(sel).forEach(el => el.classList.toggle('hidden', !visible));
      });
    }

    function getOddFinal(odd, com = 0, aum = 0) {
      const lucroComComissao = (odd - 1) * (1 - com / 100);
      const lucroFinal = lucroComComissao * (1 + aum / 100);
      const oddFinal = 1 + lucroFinal;
      return Math.max(1.001, oddFinal);
    }

    function recalcApostaTotal() {
      const rows = $$('#apostasBody tr');
      let total = 0;
      rows.forEach(row => {
        const val = parseFloat(row.querySelector('.aposta-input').value.replace(',', '.')) || 0;
        const isFree = row.querySelector('.freebet-checkbox').checked;
        if (!isFree) total += val;
      });
      $('#apostaTotalDisplay').value = total.toFixed(2);
    }

    function updateCalculations() {
      if (!isLoggedIn()) return;
      const totalDisplay = parseFloat($('#apostaTotalDisplay').value) || 100;
      const qtdContas = parseFloat($('#qtdContas')?.value) || 1;
      const totalReal = totalDisplay * qtdContas;
      const rows = $$('#apostasBody tr');
      const n = rows.length;
      const oddsOriginal = [], oddsFinal = [], comissoes = [], aumentos = [], freebets = [], isLayBet = [];

      rows.forEach((r, i) => {
        const oddRaw = parseFloat(r.querySelector('.odd-input').value) || 2;
        const com = state.showComissao ? parseFloat(r.querySelector('.comissao-input').value) || 0 : 0;
        const aum = state.showAumento ? parseFloat(r.querySelector('.aumento-input').value) || 0 : 0;
        const isLay = r.querySelector('.type-btn')?.classList.contains('lay') || false;
        oddsOriginal[i] = oddRaw;
        isLayBet[i] = isLay;
        if (isLay) {
          const layProfit = (1 / Math.max(0.001, oddRaw - 1)) * (1 - com / 100);
          oddsFinal[i] = 1 + layProfit;
        } else {
          oddsFinal[i] = getOddFinal(oddRaw, com, aum);
        }
        comissoes[i] = com;
        aumentos[i] = aum;
        freebets[i] = !!(state.showFreebet && r.querySelector('.freebet-checkbox').checked);
        const oddFinalDisplay = oddsFinal[i].toFixed(3);
        const oddFinalElement = r.querySelector('.odd-final');
        if (oddFinalElement) oddFinalElement.textContent = oddFinalDisplay;
      });

      let stakes = rows.map(r => parseFloat(r.querySelector('.aposta-input').value) || 0);

      if (!state.manualMode && state.controlIndex === null) {
        const invs = oddsFinal.map(o => 1 / (o || 1));
        const sumInv = invs.reduce((a, b) => a + b, 0) || 1;
        stakes = invs.map(inv => (totalReal * inv) / sumInv / (qtdContas || 1));
      }

      if (state.controlIndex !== null) {
        const w = state.controlIndex;
        const stakeW = stakes[w] || 0;
        const oddW = oddsFinal[w];
        const casaComCTemFreebet = freebets[w];

        if (casaComCTemFreebet) {
          const lucroFreebet = (oddsFinal[w] - 1) * stakeW;
          for (let i = 0; i < n; i++) {
            if (i === w || freebets[i]) continue;
            if (isLayBet[i]) {
              const comI = comissoes[i] || 0;
              const oddIOrig = oddsOriginal[i];
              const denominador = oddIOrig - 1 + (1 - comI / 100);
              stakes[i] = lucroFreebet / denominador;
            } else {
              stakes[i] = lucroFreebet / oddsFinal[i];
            }
          }
        } else if (!freebets.some(fb => fb)) {
          const MAX_ITER = 100;
          const TOLERANCE = 0.01;
          for (let iter = 0; iter < MAX_ITER; iter++) {
            const lucros = [];
            for (let winIndex = 0; winIndex < n; winIndex++) {
              let lucro = 0;
              for (let i = 0; i < n; i++) {
                if (i === winIndex) {
                  if (isLayBet[i]) {
                    const com = comissoes[i] || 0;
                    lucro += stakes[i] * (1 - com / 100);
                  } else {
                    lucro += (oddsFinal[i] - 1) * stakes[i];
                  }
                } else {
                  if (freebets[i]) continue;
                  else if (isLayBet[i]) lucro -= stakes[i] * (oddsOriginal[i] - 1);
                  else lucro -= stakes[i];
                }
              }
              lucros[winIndex] = lucro;
            }
            const lucroAlvo = lucros[w];
            let maxAjuste = 0;
            for (let i = 0; i < n; i++) {
              if (i === w) continue;
              const lucroAtual = lucros[i];
              const diferenca = lucroAlvo - lucroAtual;
              if (Math.abs(diferenca) > TOLERANCE) {
                const fator = isLayBet[i] ?
                  (oddsOriginal[i] - 1 + (1 - (comissoes[i] || 0) / 100)) :
                  oddsFinal[i];
                const ajuste = diferenca / fator;
                stakes[i] += ajuste * 0.5;
                stakes[i] = Math.max(0, stakes[i]);
                maxAjuste = Math.max(maxAjuste, Math.abs(ajuste));
              }
            }
            if (maxAjuste < TOLERANCE) break;
          }
        }
        let totalStakeNoFree = 0;
        stakes.forEach((val, i) => {
          if (freebets[i]) return;
          if (isLayBet[i]) totalStakeNoFree += val * (oddsOriginal[i] - 1);
          else totalStakeNoFree += val;
        });
        $('#apostaTotalDisplay').value = totalStakeNoFree.toFixed(2);
      }

      rows.forEach((r, i) => {
        const stakeValue = stakes[i] || 0;
        const apostaCell = r.querySelector('.col-aposta');
        if (isLayBet[i]) {
          const liability = stakeValue * (oddsOriginal[i] - 1);
          r.querySelector('.aposta-input').value = liability.toFixed(2);
          let responsInfo = apostaCell.querySelector('.respons-info');
          if (!responsInfo) {
            responsInfo = document.createElement('div');
            responsInfo.className = 'respons-info';
            responsInfo.style.cssText = 'font-size: 10px; color: #6b7280; margin-top: 4px;';
            apostaCell.appendChild(responsInfo);
          }
          responsInfo.textContent = `Responsabilidade: ${stakeValue.toFixed(2)}`;
        } else {
          r.querySelector('.aposta-input').value = stakeValue.toFixed(2);
          const responsInfo = apostaCell.querySelector('.respons-info');
          if (responsInfo) responsInfo.remove();
        }
      });

      const stakesReal = stakes.map(s => (s || 0) * (qtdContas || 1));
      const lucros = [];
      for (let w = 0; w < n; w++) {
        let lucroW = 0;
        for (let i = 0; i < n; i++) {
          if (i === w) {
            if (freebets[i]) lucroW += (oddsFinal[i] - 1) * stakesReal[i];
            else if (isLayBet[i]) {
              const com = comissoes[i] || 0;
              lucroW += stakesReal[i] * (1 - com / 100);
            } else {
              lucroW += (oddsFinal[i] - 1) * stakesReal[i];
            }
          } else {
            if (freebets[i]) continue;
            else if (isLayBet[i]) lucroW -= stakesReal[i] * (oddsOriginal[i] - 1);
            else lucroW -= stakesReal[i];
          }
        }
        lucros[w] = lucroW;
      }

      rows.forEach((r, i) => {
        const el = r.querySelector('.lucro-output');
        const lucroCalculado = lucros[i] || 0;
        el.textContent = lucroCalculado.toFixed(2);
        el.style.color = lucroCalculado >= 0 ? "#22bb33" : "#cc3333";
      });

      let totalStakeReal = 0;
      stakesReal.forEach((val, i) => {
        if (freebets[i]) return;
        if (isLayBet[i]) totalStakeReal += val * (oddsOriginal[i] - 1);
        else totalStakeReal += val;
      });
      const minLucro = Math.min(...lucros);
      const perc = totalStakeReal ? (minLucro / totalStakeReal) * 100 : 0;
      $('#stakeTotal').textContent = money(totalStakeReal);
      $('#lucroTotal').textContent = money(minLucro);
      $('#porcentagem').textContent = perc.toFixed(2) + " %";
      updateResultsTable(lucros, stakesReal, oddsFinal);
    }

    function updateResultsTable(lucros, stakesReal, oddsFinal) {
      const tbody = $('#resultsBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = $$('#apostasBody tr');
      rows.forEach((r, i) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${r.querySelector('.casa-input').value}</td>
          <td>${oddsFinal[i].toFixed(3)}</td>
          <td>${stakesReal[i].toFixed(2)}</td>
          <td>${r.querySelector('.type-btn').textContent}</td>
          <td style="color: ${lucros[i] >= 0 ? '#22bb33' : '#cc3333'}">${lucros[i].toFixed(2)}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function init() {
      updateNavbar();
      updateInputsState();

      $('#qtdCasas')?.addEventListener('change', () => {
        if (!isLoggedIn()) return;
        state.qtdCasas = parseInt($('#qtdCasas').value) || 2;
        renderRows();
        updateCalculations();
      });

      $('#btnAddPlanilha')?.addEventListener('click', () => {
        if (!isLoggedIn()) return;
        const today = new Date().toISOString().split('T')[0];
        const qtdContas = parseInt($('#qtdContas').value) || 1;
        const lucro = parseFloat($('#lucroTotal').textContent.replace('R$ ', '').replace(/\./g, '').replace(',', '.')) || 0;
        const firstCasa = $('#apostasBody .casa-input')?.value || 'Várias casas';
        let mercado = 'SURE';
        if (state.showFreebet) mercado = 'FB/BÔNUS';
        else if (state.showCashback) mercado = 'CASHBACK';
        $('#formData').value = today;
        $('#formCasa').value = firstCasa;
        $('#formDescricao').value = `Arbitragem com ${state.qtdCasas} casas`;
        $('#formObservacoes').value = '';
        $('#formMercado').value = mercado;
        $('#formSituacao').value = 'CONCLUÍDO';
        $('#formLucro').value = lucro.toFixed(2).replace('.', ',');
        $('#formQtdContas').value = qtdContas;
        $('#modalAddPlanilha').classList.remove('hidden');
      });

      $('#cancelModal')?.addEventListener('click', () => {
        $('#modalAddPlanilha').classList.add('hidden');
      });
      $('#modalAddPlanilha')?.addEventListener('click', (e) => {
        if (e.target === $('#modalAddPlanilha')) {
          $('#modalAddPlanilha').classList.add('hidden');
        }
      });

      $('#saveToPlanilha')?.addEventListener('click', async () => {
        const email = localStorage.getItem('superodd_user_email');
        if (!email) {
          alert('⚠️ Faça login novamente.');
          return;
        }
        const payload = {
          email,
          data: $('#formData').value,
          casa: $('#formCasa').value,
          descricao: $('#formDescricao').value,
          observacoes: $('#formObservacoes').value,
          mercado: $('#formMercado').value,
          situacao: $('#formSituacao').value,
          lucro: parseFloat($('#formLucro').value.replace(',', '.')) || 0,
          qtdContas: parseInt($('#formQtdContas').value) || 1
        };
        try {
          const res = await fetch('/api/records', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await res.json();
          if (result.success) {
            alert('✅ Registro salvo na planilha!');
            $('#modalAddPlanilha').classList.add('hidden');
          } else {
            alert('❌ Erro: ' + (result.message || 'Falha ao salvar.'));
          }
        } catch (err) {
          console.error(err);
          alert('⚠️ Erro de conexão com o servidor.');
        }
      });

      $('#qtdContas')?.addEventListener('input', () => {
        if (isLoggedIn()) updateCalculations();
      });

      $('#apostaTotalDisplay')?.addEventListener('input', () => {
        if (!isLoggedIn()) return;
        state.manualMode = true;
        state.controlIndex = null;
        $$('.comissao-checkbox').forEach(c => c.checked = false);
        updateCalculations();
      });

      ['switchFreebet', 'switchCashback', 'switchComissao', 'switchAumento'].forEach(id => {
        const el = $('#' + id);
        const key = {
          switchFreebet: 'showFreebet',
          switchCashback: 'showCashback',
          switchComissao: 'showComissao',
          switchAumento: 'showAumento'
        }[id];
        el?.addEventListener('click', () => {
          if (!isLoggedIn()) return;
          el.classList.toggle('on');
          state[key] = el.classList.contains('on');
          renderTableColumns();
          updateCalculations();
        });
      });

      $('#btnCopyAposta')?.addEventListener('click', () => {
        if (!isLoggedIn()) return;
        navigator.clipboard.writeText($('#apostaTotalDisplay').value);
      });

      renderRows();
      if (isLoggedIn()) updateCalculations();
      setInterval(updateInputsState, 800);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>