<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fábrica Super Odd — Calculadora</title>
  <link rel="icon" href="image/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css      ">
  <style>
    :root{
      --primary: #1f2b3a;
      --accent: #f3e5a6;
      --accent-strong: #e9d984;
      --muted: #6b7280;
      --card: #ffffff;
      --soft: #f5f7fa;
      --shadow: 0 6px 20px rgba(18,24,36,0.06);
      --watermark-opacity: 0.04;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif}
    html,body{height:100%;background:#f6f7fb;color:#111;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    a{color:inherit;text-decoration:none}
    html,body{overflow:auto}
    * { scrollbar-width: none; -ms-overflow-style: none; }
    *::-webkit-scrollbar { display: none; width:0; height:0; }
    .wrap{max-width:1150px;margin:28px auto;padding:18px}
    .navbar{display:flex;align-items:center;justify-content:space-between;background:var(--card);padding:14px 18px;border-radius:10px;box-shadow:var(--shadow);gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:8px;background:url('image/logo.png') center/contain no-repeat}
    .brand h1{font-size:16px;font-weight:700;color:#0f1724}
    .nav-actions{display:flex;align-items:center;gap:10px}
    .nav-actions button{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    .nav-actions .icon-btn{background:transparent;color:var(--muted);width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;border:1px solid #e6e9ee}
    .section{
      background:var(--card);
      border-radius:12px;
      padding:18px;
      margin-top:18px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .section::before,
    .table-wrap::before,
    .results-left::before,
    .summary-card::before {
      content:'';
      position:absolute;
      right:12px;
      bottom:6px;
      width:140px;
      height:140px;
      background-image:url('image/logo.png');
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      opacity:var(--watermark-opacity);
      pointer-events:none;
      filter:grayscale(1);
      mix-blend-mode: lighten;
    }
    .table-wrap::before,
    .results-left::before {
      inset:0;
      background-size:200px;
      background-repeat:repeat;
    }
    h2{
      font-size:20px;
      margin-bottom:12px;
      color:#0b1720;
      background:var(--card);
      padding:12px;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.03);
      margin-top:-6px;
      margin-left:-18px;
      margin-right:-18px;
    }
    .sub{color:var(--muted);font-size:13px;margin-bottom:8px}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
    .field{display:flex;flex-direction:column;gap:8px}
    label{font-size:14px;color:#24303a;font-weight:600}
    select,input[type="number"],input[type="text"]{padding:10px 12px;border-radius:8px;border:1px solid #e6f0e9;background:#fff;outline:none}
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%, #9ca3af 50%), linear-gradient(135deg,#9ca3af 50%, transparent 50%); background-position:calc(100% - 12px) calc(1em + 2px), calc(100% - 7px) calc(1em + 2px); background-size:6px 6px,6px 6px; background-repeat:no-repeat}
    input:focus,select:focus{border-color: var(--accent-strong); box-shadow: 0 0 0 6px rgba(233,217,132,0.06)}
    .toggles{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .toggle{display:flex;align-items:center;gap:10px}
    .switch{position:relative;width:44px;height:26px;border-radius:16px;background:#eee;cursor:pointer}
    .switch input{display:none}
    .knob{position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:all .22s}
    .switch.on{background:var(--accent-strong)}
    .switch.on .knob{transform:translateX(18px)}
    .toggle-note {font-size:12px;color:var(--muted);margin-top:6px;display:block;}
    .table-wrap{margin-top:6px;border-radius:10px;overflow:visible;position:relative;min-width:300px;}
    table{width:100%;border-collapse:separate;border-spacing:0;background:transparent;table-layout:fixed;}
    thead th{
      background:var(--primary);
      color:#fff;
      padding:12px 8px;
      border-top-left-radius:8px;
      border-top-right-radius:8px;
      font-weight:700;
      text-align:left;
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      border-left:1px solid rgba(255,255,255,0.06);
    }
    thead th:first-child{border-left:none;}
    tbody tr{background:#f6f7f9}
    tbody tr + tr{margin-top:8px}
    tbody td{
      padding:8px 6px;
      border-bottom:1px solid rgba(16,24,32,0.04);
      vertical-align:middle;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-size:13px;
    }
    /* Colunas dinâmicas */
    .col-casa{width:14%}
    .col-tipo{width:7%}
    .col-odd{width:7%}
    .col-comissao{width:8%}
    .col-oddfinal{width:8%}
    .col-aumento{width:7%}
    .col-aposta{width:12%}
    .col-freebet{width:9%}
    .col-cashback{width:9%}
    .col-c{width:8%}
    .col-lucro{width:11%}
    tbody td input[type="text"],
    tbody td input[type="number"]{
      border:1px solid #dfe7d0;
      padding:5px 6px;
      border-radius:5px;
      background:#fff;
      font-size:12px;
      width:100%;
      box-sizing:border-box;
    }
    .type-btn{
      display:inline-block;
      padding:4px 8px;
      border-radius:5px;
      font-weight:700;
      font-size:12px;
      cursor:pointer;
      border:none;
      width:100%;
      text-align:center;
    }
    .type-btn.back{background:rgba(0,0,0,0.05);color:#0f1724}
    .type-btn.lay{background:rgba(255,0,0,0.08);color:#8b1f1f}
    .chk {
      display:flex;
      align-items:center;
      justify-content:center;
      height:100%;
    }
    .chk input{display:none}
    .chk .chkbox{
      width:20px;
      height:16px;
      border-radius:4px;
      border:1px solid #ddd;
      display:inline-block;
      position:relative;
      transition:all .18s;
      background:#fff;
    }
    .chk .chkbox::after{
      content:'';position:absolute;left:5px;top:0;width:5px;height:9px;border:solid #fff;border-width:0 2px 2px 0;transform:rotate(45deg);opacity:0;transition:opacity .14s;
    }
    .chk input:checked + .chkbox{
      background:var(--accent);
      border-color:var(--accent-strong);
    }
    .chk input:checked + .chkbox::after{opacity:1}
    .col-freebet.hidden,
    .col-cashback.hidden,
    .col-comissao.hidden,
    .col-aumento.hidden {
      display: none !important;
    }
    .results-wrap {
      margin-top: 8px;
      display:flex;
      gap:16px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .results-left {
      flex:1 1 600px;
      min-width:300px;
      border-radius:10px;
      overflow:hidden;
      background:var(--card);
      border:1px solid #e9eef0;
      position:relative;
    }
    .results-table {
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    .results-table thead th {
      background:var(--primary);
      color:#fff;
      padding:10px;
      font-weight:700;
      text-align:left;
      font-size:13px;
    }
    .results-table td {
      padding:10px;
      border-bottom:1px solid rgba(16,24,32,0.04);
      background:#fff;
      font-size:14px;
    }
    .results-right {
      width:240px;
      min-width:200px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .results-actions {
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .results-actions .btn {
      width:100%;
      display:block;
      text-align:center;
    }
    .summary-cards {
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:12px;
    }
    .summary-card {
      background:var(--card);
      border-radius:10px;
      padding:14px;
      border:1px solid #eef6f8;
      position:relative;
      overflow:hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .summary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    .summary-card .label {
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .summary-card .value {
      font-weight:800;
      margin-top:6px;
      font-size:16px;
      color:var(--primary);
    }
    .summary-card .value.highlight {
      color: var(--accent);
    }
    .highlight{color:var(--accent);font-weight:800}
    .actions{display:flex;gap:12px;margin-top:12px}
    .btn{padding:10px 14px;border-radius:8px;border:none;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6e9ee;color:var(--muted)}
    .modal-backdrop{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(3,6,12,0.45);
      z-index:60;
    }
    .modal{
      width:360px;
      background:#fff;
      padding:18px;
      border-radius:12px;
      box-shadow:0 10px 40px rgba(2,6,23,0.35);
    }
    .modal h3{margin-bottom:10px}
    .modal .muted{font-size:13px;color:var(--muted);margin-bottom:12px}
    .modal .row{display:flex;gap:8px}
    .modal .small{font-size:13px;color:var(--muted);margin-top:8px}
    .admin-box{margin-top:10px;padding:12px;border-radius:8px;border:1px dashed #e6eef0;background:#fbfeff}
    .admin-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .file-input{display:none}
    @media (max-width:1024px){
    }
    @media (max-width:768px){
      .grid2{grid-template-columns:1fr}
      .wrap{padding:12px}
      .modal{width:92%}
      .results-wrap{flex-direction:column}
      .results-right{width:100%;min-width:0;flex-direction:row;gap:8px;flex-wrap:wrap}
      .results-actions{flex-direction:row;width:100%}
      .results-actions .btn{flex:1}
      .summary-cards{
        grid-template-columns:repeat(3,1fr);
        gap:8px;
      }
      .summary-card{
        padding:10px;
        border-radius:8px;
        font-size:13px;
      }
      .summary-card .value{
        font-size:14px;
      }
      #apostasTable,
      #apostasTable thead,
      #apostasTable tbody,
      #apostasTable th,
      #apostasTable td,
      #apostasTable tr {
        display: block;
      }
      #apostasTable thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }
      #apostasTable tr {
        border: 1px solid #e3e7ea;
        padding: 12px;
        margin-bottom: 12px;
        display: block;
        background: #fff;
        border-radius:8px;
      }
      #apostasTable td {
        border: none;
        position: relative;
        padding-left: 48%;
        white-space: normal;
        text-align: left;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:8px;
      }
      #apostasTable td::before {
        content: attr(data-label) ": ";
        position: absolute;
        left: 12px;
        width: 40%;
        font-weight: 700;
        text-align: left;
        color: #24303a;
      }
      #apostasTable td input[type="text"],
      #apostasTable td input[type="number"]{
        max-width:110px;
        width:110px;
      }
      .type-btn{padding:6px 10px;font-size:13px}
      .chk .chkbox{width:24px;height:18px}
      tfoot td {
        display: block !important;
        text-align: right !important;
        padding: 12px !important;
      }
      .aposta-total {
        justify-content: space-between;
        display:flex;
        gap:8px;
        align-items:center;
      }
      .aposta-total input {
        width: 110px;
        text-align: right;
        font-size:14px;
      }
      .results-left { order: 0; width:100% }
      .results-right { order: 1; width:100%; display:flex; gap:8px; flex-wrap:wrap }
      .results-actions { width:100%; display:flex; gap:8px }
      .summary-cards { grid-template-columns:repeat(3,1fr); width:100% }
      .btn, .type-btn { touch-action: manipulation; }
    }

    /* Small improvement: guarantee tfoot input aligns visually below "Aposta" column */
    tfoot td.aposta-foot {
      padding: 8px 6px;
      text-align: left;
      vertical-align: middle;
    }
    tfoot td.aposta-foot .aposta-total { align-items:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="navbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Fábrica Super Odd</h1>
          <div class="small">Calculadora de Arbitragem</div>
        </div>
      </div>
      <div class="nav-actions">
        <a href="#" id="btnOpenLogin" title="Entrar / Sair" style="background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;text-decoration:none;display:inline-block">Entrar</a>
      </div>
    </div>
    <div class="section">
      <h2>Configurações</h2>
      <div class="sub">Defina o procedimento e as opções.</div>
      <div class="grid2" style="margin-top:12px">
        <div class="field">
          <label>Procedimento</label>
          <select id="procedimento" disabled>
            <option>Arbitragem Simples</option>
            <option>Freebet</option>
            <option>Cashback</option>
          </select>
        </div>
        <div class="field">
          <label>Quantidade de casas</label>
          <select id="qtdCasas" disabled>
            <option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option>
          </select>
        </div>
        <div class="field">
          <label>Quantidade de contas</label>
          <input id="qtdContas" type="number" min="1" value="1" disabled>
          <div class="small">Multiplica stake e lucro final</div>
        </div>
      </div>
      <div style="margin-top:14px" class="toggles">
        <div class="toggle" title="Ativa coluna 'Freebet'">
          <div id="switchFreebet" class="switch"><div class="knob"></div></div>
          <div class="small">Usar Freebet</div>
        </div>
        <div class="toggle" title="Ativa coluna 'Cashback'">
          <div id="switchCashback" class="switch"><div class="knob"></div></div>
          <div class="small">Usar Cashback</div>
        </div>
        <div class="toggle" title="Exibir comissão">
          <div id="switchComissao" class="switch on"><div class="knob"></div></div>
          <div class="small">Exibir comissão</div>
        </div>
        <div class="toggle" title="Exibir aumento">
          <div id="switchAumento" class="switch"><div class="knob"></div></div>
          <div class="small">Exibir aumento</div>
        </div>
      </div>
      <div class="toggle-note">
        • <strong>Freebet</strong>: aposta grátis.<br>
        • <strong>Cashback</strong>: recupera % em caso de perda.
      </div>
    </div>
    <div class="section">
      <h2>Linhas de Apostas</h2>
      <div class="sub">Insira odds e o sistema distribuirá automaticamente.</div>
      <div class="table-wrap">
        <table id="apostasTable" aria-label="Linhas de apostas">
          <thead>
            <tr>
              <th class="col-casa">Casa</th>
              <th class="col-tipo">Tipo</th>
              <th class="col-odd">ODD</th>
              <th class="col-comissao">Comissão %</th>
              <th class="col-oddfinal">ODD Final</th>
              <th class="col-aumento">Aumento %</th>
              <th class="col-aposta">Aposta</th>
              <th class="col-freebet">Freebet</th>
              <th class="col-cashback">Cashback %</th>
              <th class="col-c">C</th>
              <th class="col-lucro">Lucro</th>
            </tr>
          </thead>
          <tbody id="apostasBody"></tbody>
          <tfoot>
            <tr>
              <!-- Aposta total fixada exatamente sob a coluna "Aposta" -->
              <td colspan="6"></td>
              <td colspan="1" class="aposta-foot">
                <div class="aposta-total" style="display: flex; align-items: center; gap: 6px;">
                  <strong>Aposta total:</strong>
                  <input id="apostaTotalDisplay" type="number" step="0.01" value="100.00" style="width: 90px; padding: 4px 6px; font-size: 12px;">
                  <button class="btn ghost" id="btnCopyAposta" disabled style="padding: 4px 6px; width: auto;">📋</button>
                </div>
              </td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="section">
      <h2>Resultados</h2>
      <div class="results-wrap">
        <div class="results-left">
          <table class="results-table">
            <thead><tr><th>Casa</th><th>ODD</th><th>Aposta</th><th>Tipo</th><th>Lucro</th></tr></thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
        <div class="results-right">
          <div class="results-actions">
            <button class="btn" id="btnShare" disabled>📤 Compartilhar</button>
            <button class="btn ghost" id="btnAddPlanilha" disabled>📊 Adicionar à planilha</button>
          </div>
          <div class="summary-cards">
            <div class="summary-card"><div class="label">Stake Total</div><div class="value highlight" id="stakeTotal">R$ 0.00</div></div>
            <div class="summary-card"><div class="label">Porcentagem</div><div class="value" id="porcentagem">0.00 %</div></div>
            <div class="summary-card"><div class="label">Lucro (pior cenário)</div><div class="value highlight" id="lucroTotal">R$ 0.00</div></div>
          </div>
        </div>
      </div>
    </div>
    <div id="adminPanel" class="section" style="display:none"></div>
  </div>
  <div id="modal" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <h3 id="modalTitle">Entrar</h3>
      <div class="muted">Use seu e-mail e senha.</div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn" id="btnModalLogin">Login</button>
        <button class="btn ghost" id="btnModalRegister">Cadastrar</button>
      </div>
      <div style="margin-top:8px"><label>Email</label><input id="authEmail" type="text" placeholder="seu@email.com"></div>
      <div style="margin-top:8px"><label>Senha</label><input id="authPass" type="password" placeholder="senha"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="btnDoAuth">Confirmar</button>
        <button class="btn ghost" id="btnCloseModal">Fechar</button>
      </div>
    </div>
  </div>
  <script>
    /* =========
       Estado & utilitários
       ========= */
    const state = {
      qtdCasas: 2,
      showComissao: true,
      showAumento: false,
      showFreebet: false,
      showCashback: false,
      controlIndex: null,   // índice da linha com "C" selecionado (referência)
      manualMode: false
    };
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const money = v => Number(v || 0).toFixed(2);

    function isLoggedIn() {
      return localStorage.getItem('superodd_logged_in') === 'true';
    }

    function logout() {
      localStorage.removeItem('superodd_logged_in');
      window.location.href = 'login.html';
    }

    function updateNavbar() {
      const btn = $('#btnOpenLogin');
      if (isLoggedIn()) {
        btn.textContent = 'Sair';
        btn.onclick = e => { e.preventDefault(); logout(); };
      } else {
        btn.textContent = 'Entrar';
        btn.onclick = e => { e.preventDefault(); window.location.href = 'login.html'; };
      }
    }

    function updateInputsState() {
      const logged = isLoggedIn();
      $('#procedimento').disabled = !logged;
      $('#qtdCasas').disabled = !logged;
      $('#qtdContas').disabled = !logged;
      $('#btnCopyAposta').disabled = !logged;
      $('#btnShare').disabled = !logged;
      $('#btnAddPlanilha').disabled = !logged;
      $('#apostaTotalDisplay').disabled = !logged;
      $$('#apostasBody input, #apostasBody button, .comissao-checkbox, .freebet-checkbox').forEach(el => {
        el.disabled = !logged;
      });
    }

    /* =========
       Criação das linhas
       ========= */
    function createRow(i) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="col-casa"><input class="casa-input" type="text" value="Casa ${i+1}"></td>
        <td class="col-tipo"><button class="type-btn back">BACK</button></td>
        <td class="col-odd"><input class="odd-input" type="number" step="0.001" min="1.001" value="2.000"></td>
        <td class="col-comissao"><input class="comissao-input" type="number" step="0.01" min="0" value="0.00"></td>
        <td class="col-oddfinal"><span class="odd-final">2.000</span></td>
        <td class="col-aumento"><input class="aumento-input" type="number" step="0.01" min="0" value="0.00"></td>
        <td class="col-aposta"><input class="aposta-input" type="number" step="0.01" min="0" value="0.00"></td>
        <td class="col-freebet">
          <label class="chk"><input class="freebet-checkbox" type="checkbox"><span class="chkbox"></span></label>
        </td>
        <td class="col-cashback"><input class="cashback-input" type="number" step="0.01" min="0" value="0.00" placeholder="%"></td>
        <td class="col-c">
          <label class="chk"><input class="comissao-checkbox" type="checkbox"><span class="chkbox"></span></label>
        </td>
        <td class="col-lucro"><span class="lucro-output">0.00</span></td>
      `;

      // Type button (BACK / LAY)
      const typeBtn = tr.querySelector('.type-btn');
      typeBtn.addEventListener('click', () => {
        if (!isLoggedIn()) return;
        const isBack = typeBtn.classList.contains('back');
        if (isBack) {
          typeBtn.classList.remove('back');
          typeBtn.classList.add('lay');
          typeBtn.textContent = 'LAY';
        } else {
          typeBtn.classList.remove('lay');
          typeBtn.classList.add('back');
          typeBtn.textContent = 'BACK';
        }
        updateCalculations();
      });

      // Inputs (odd, comissao, aumento, aposta, cashback)
      const inputs = tr.querySelectorAll('input:not(.comissao-checkbox):not(.freebet-checkbox)');
      inputs.forEach(input => {
        input.addEventListener('input', (ev) => {
          if (!isLoggedIn()) return;
          // When user edits aposta-input manually -> manual mode
          if (input.classList.contains('aposta-input')) {
            state.manualMode = true;
            state.controlIndex = null; // remove control when user manually edits aposta
            // uncheck C boxes
            $$('.comissao-checkbox').forEach(cb => cb.checked = false);
            recalculateTotalFromIndividuals();
          }
          updateCalculations();
        });
      });

      // C checkbox (control). Note: class name 'comissao-checkbox' preserved to match markup (you used it)
      const checkbox = tr.querySelector('.comissao-checkbox');
      checkbox.addEventListener('change', () => {
        if (!isLoggedIn()) return;
        if (checkbox.checked) {
          // Only one C allowed
          $$('.comissao-checkbox').forEach(cb => {
            if (cb !== checkbox) {
              cb.checked = false;
            }
          });
          // set control index based on current position in DOM
          const all = $$('#apostasBody tr');
          state.controlIndex = all.indexOf(tr);
          state.manualMode = false;
        } else {
          // if unchecked, clear control
          state.controlIndex = null;
        }
        updateCalculations();
      });

      // Freebet checkbox (can be many)
      const freebetCheckbox = tr.querySelector('.freebet-checkbox');
      freebetCheckbox.addEventListener('change', () => {
        if (!isLoggedIn()) return;
        // toggling freebet influences calculations
        updateCalculations();
      });

      return tr;
    }

    function recalculateTotalFromIndividuals() {
      const rows = $$('#apostasBody tr');
      let total = 0;
      const qtdContas = parseFloat($('#qtdContas').value) || 1;
      rows.forEach(row => {
        const aposta = parseFloat(row.querySelector('.aposta-input').value) || 0;
        total += aposta;
      });
      $('#apostaTotalDisplay').value = (total / (qtdContas || 1)).toFixed(2);
    }

    function renderRows() {
      const tbody = $('#apostasBody');
      tbody.innerHTML = '';
      for (let i = 0; i < state.qtdCasas; i++) {
        tbody.appendChild(createRow(i));
      }
      renderTableColumns();
      updateFreebetCashbackFields();
      updateInputsState();
    }

    function renderTableColumns() {
      const cols = {
        colFreebet: state.showFreebet,
        colCashback: state.showCashback,
        colComissao: state.showComissao,
        colAumento: state.showAumento
      };
      $$('.col-freebet').forEach(el => el.classList.toggle('hidden', !cols.colFreebet));
      $$('.col-cashback').forEach(el => el.classList.toggle('hidden', !cols.colCashback));
      $$('.col-comissao').forEach(el => el.classList.toggle('hidden', !cols.colComissao));
      $$('.col-aumento').forEach(el => el.classList.toggle('hidden', !cols.colAumento));

      // recompute widths (same as before)
      const visibleCols = [
        '.col-casa',
        '.col-tipo',
        '.col-odd',
        '.col-comissao',
        '.col-oddfinal',
        '.col-aumento',
        '.col-aposta',
        '.col-freebet',
        '.col-cashback',
        '.col-c',
        '.col-lucro'
      ].filter(cls => {
        const els = $$(cls);
        return els.length > 0 && !els[0].classList.contains('hidden');
      }).length;

      const width = Math.floor(100 / visibleCols) + '%';
      $$('.col-casa, .col-tipo, .col-odd, .col-comissao, .col-oddfinal, .col-aumento, .col-aposta, .col-freebet, .col-cashback, .col-c, .col-lucro').forEach(el => {
        if (!el.classList.contains('hidden')) {
          el.style.width = width;
        }
      });
    }

    function updateFreebetCashbackFields() {
      const rows = $$('#apostasBody tr');
      rows.forEach(row => {
        const free = row.querySelector('.freebet-checkbox');
        const cb = row.querySelector('.cashback-input');
        if (free) free.parentElement.classList.toggle('hidden', !state.showFreebet);
        if (cb) {
          cb.parentElement.classList.toggle('hidden', !state.showCashback);
          if (state.showCashback && parseFloat(cb.value) === 0) cb.value = '5.00';
        }
      });
    }

    function getEffectiveOdd(odd, comissao = 0, aumento = 0) {
      let oddAjustada = odd * (1 + (aumento || 0) / 100);
      oddAjustada = oddAjustada * (1 - (comissao || 0) / 100);
      return Math.max(1.001, oddAjustada);
    }

    /* =========
       Função que monta o sistema linear e resolve stakes quando há C selecionado.
       Modelo:
         profit_j = sum_i coef[j][i]*stake_i + const_j
       stake variables = stakes of indices != control (in real currency, já multiplicados por qtdContas)
       ========= */

    // Solve linear system Ax = b using Gaussian elimination (returns null if singular)
    function solveLinearSystem(A, b) {
      const n = A.length;
      // make augmented matrix
      const M = A.map((row, i) => row.concat([b[i]]));
      for (let k = 0; k < n; k++) {
        // find pivot
        let i_max = k;
        let max_val = Math.abs(M[k][k]);
        for (let i = k + 1; i < n; i++) {
          if (Math.abs(M[i][k]) > max_val) {
            max_val = Math.abs(M[i][k]);
            i_max = i;
          }
        }
        if (Math.abs(M[i_max][k]) < 1e-12) return null; // singular
        // swap
        if (i_max !== k) {
          const tmp = M[k]; M[k] = M[i_max]; M[i_max] = tmp;
        }
        // normalize pivot row
        const pivot = M[k][k];
        for (let j = k; j <= n; j++) M[k][j] /= pivot;
        // eliminate
        for (let i = 0; i < n; i++) {
          if (i === k) continue;
          const factor = M[i][k];
          if (Math.abs(factor) < 1e-14) continue;
          for (let j = k; j <= n; j++) {
            M[i][j] -= factor * M[k][j];
          }
        }
      }
      // extract solution
      return M.map(row => row[n]);
    }

    function calculateScenarioProfits(apostas, odds, isLay, freebets, cashbacks) {
      const n = apostas.length;
      const profits = [];
      for (let winIndex = 0; winIndex < n; winIndex++) {
        let totalRetorno = 0;
        let totalRisco = 0;
        for (let i = 0; i < n; i++) {
          const aposta = apostas[i];
          const odd = odds[i];
          const isFreebet = freebets[i];
          const cashback = cashbacks[i] || 0;
          const isLayHere = isLay[i];
          if (isLayHere) {
            if (i === winIndex) {
              // Lay perde (liability)
              const perda = (odd - 1) * aposta;
              totalRisco += perda;
            } else {
              // Lay ganha stake
              totalRetorno += aposta;
            }
          } else {
            if (i === winIndex) {
              if (isFreebet) {
                totalRetorno += (odd - 1) * aposta;
              } else {
                totalRetorno += odd * aposta;
              }
            } else {
              const perda = aposta;
              const perdaLiquida = perda * (1 - (cashback || 0) / 100);
              totalRisco += perdaLiquida;
            }
          }
        }
        const lucro = totalRetorno - totalRisco;
        profits.push(lucro);
      }
      return profits;
    }

    /* =========
       updateCalculations: toda a lógica principal (nova/refatorada)
       ========= */
    function updateCalculations() {
      // if login gating present, respect it
      if (!isLoggedIn()) return;

      const totalDisplay = $('#apostaTotalDisplay');
      let totalValue = parseFloat(totalDisplay.value) || 100;
      const qtdContas = parseFloat($('#qtdContas').value) || 1;
      const totalReal = totalValue * qtdContas; // real total stake (multiplica contas)
      const rows = $$('#apostasBody tr');

      // gather data per row
      const odds = [], freebets = [], cashbacks = [], isLay = [], comissoes = [], aumentos = [];
      rows.forEach((row, i) => {
        const oddRaw = parseFloat(row.querySelector('.odd-input').value) || 2.0;
        const comissao = state.showComissao ? parseFloat(row.querySelector('.comissao-input').value) || 0 : 0;
        const aumento = state.showAumento ? parseFloat(row.querySelector('.aumento-input').value) || 0 : 0;
        const isFreebet = state.showFreebet && row.querySelector('.freebet-checkbox').checked;
        const cashback = state.showCashback ? parseFloat(row.querySelector('.cashback-input').value) || 0 : 0;
        const tipoBtn = row.querySelector('.type-btn');
        const lay = tipoBtn.classList.contains('lay');

        const effOdd = getEffectiveOdd(oddRaw, comissao, aumento);

        odds[i] = effOdd;
        freebets[i] = isFreebet;
        cashbacks[i] = cashback;
        isLay[i] = lay;
        comissoes[i] = comissao;
        aumentos[i] = aumento;

        row.querySelector('.odd-final').textContent = effOdd.toFixed(3);
      });

      // current apostas (per account)
      let apostasPerAccount = Array(rows.length).fill(0);
      rows.forEach((row, i) => {
        apostasPerAccount[i] = parseFloat(row.querySelector('.aposta-input').value) || 0;
      });

      // Work in "real stakes" (consider qtdContas). stakesReal = apostasPerAccount * qtdContas
      let stakesReal = apostasPerAccount.map(a => a * qtdContas);

      // If there's a controlIndex, compute stakes for others so that all profits equal profit_control
      if (state.controlIndex !== null) {
        const refIndex = state.controlIndex;
        const stakeRefReal = stakesReal[refIndex]; // fixed (if user hasn't set, can be zero -> then no solution)
        // Build linear system for variables = stakesReal of indices != refIndex
        const n = rows.length;
        const varIndices = [];
        for (let i = 0; i < n; i++) if (i !== refIndex) varIndices.push(i);

        // Build coefficients: for each outcome j (we'll create equations profit_j - profit_ref = 0 for j != refIndex)
        // profit_j = sum_i coef[j][i]*stake_i + const_j (const_j includes contributions from ref stake)
        // We'll create one equation for each j != refIndex, unknowns are stake_i for i in varIndices.
        const m = varIndices.length;
        if (m === 0) {
          // only one row -> nothing to do
        } else {
          const A = []; // (m x m)
          const b = []; // m vector

          // Precompute contribution from ref stake to each profit (const term)
          const constFromRef = new Array(n).fill(0);
          for (let j = 0; j < n; j++) {
            // contribution of refIndex stake to profit when outcome j occurs
            const stake = stakeRefReal;
            const odd = odds[refIndex];
            const isFree = freebets[refIndex];
            const cashback = cashbacks[refIndex] || 0;
            const lay = isLay[refIndex];
            if (lay) {
              if (refIndex === j) {
                // ref is lay and its own selection wins -> ref loses liability
                constFromRef[j] += - (odd - 1) * stake;
              } else {
                // ref lay and another outcome wins -> ref wins stake
                constFromRef[j] += stake;
              }
            } else {
              if (refIndex === j) {
                // ref back wins
                if (isFree) {
                  constFromRef[j] += (odd - 1) * stake;
                } else {
                  constFromRef[j] += odd * stake;
                }
              } else {
                // ref back loses on other outcomes
                constFromRef[j] += - (stake * (1 - (cashback || 0) / 100));
              }
            }
          }

          // For each equation (for j != refIndex), build coefficients for unknown stakes and RHS = - (constFromRef[j] - constFromRef[refIndex])
          const eqIndices = [];
          for (let j = 0; j < n; j++) if (j !== refIndex) eqIndices.push(j);

          for (let eq = 0; eq < eqIndices.length; eq++) {
            const j = eqIndices[eq]; // the outcome index for this equation
            const rowA = new Array(m).fill(0);
            // compute coefficients of unknown stakes on profit_j - profit_ref
            for (let u = 0; u < m; u++) {
              const i = varIndices[u]; // stake variable index
              const odd_i = odds[i];
              const isFree_i = freebets[i];
              const cashback_i = cashbacks[i] || 0;
              const lay_i = isLay[i];

              // contribution of stake_i to profit when outcome j occurs:
              let coef_j_i = 0;
              if (lay_i) {
                if (i === j) {
                  coef_j_i += - (odd_i - 1);
                } else {
                  coef_j_i += 1;
                }
              } else {
                if (i === j) {
                  if (isFree_i) coef_j_i += (odd_i - 1);
                  else coef_j_i += odd_i;
                } else {
                  coef_j_i += - (1 - (cashback_i || 0) / 100);
                }
              }

              // contribution of stake_i to profit when outcome refIndex occurs:
              let coef_ref_i = 0;
              if (lay_i) {
                if (i === refIndex) {
                  coef_ref_i += - (odd_i - 1);
                } else {
                  coef_ref_i += 1;
                }
              } else {
                if (i === refIndex) {
                  if (isFree_i) coef_ref_i += (odd_i - 1);
                  else coef_ref_i += odd_i;
                } else {
                  coef_ref_i += - (1 - (cashback_i || 0) / 100);
                }
              }

              // coefficient in equation profit_j - profit_ref = 0 is coef_j_i - coef_ref_i
              rowA[u] = coef_j_i - coef_ref_i;
            }

            // RHS: -(constFromRef[j] - constFromRef[refIndex]) because constants from ref are like known contributions
            const rhs = - (constFromRef[j] - constFromRef[refIndex]);

            A.push(rowA);
            b.push(rhs);
          }

          // Solve A * x = b for x = stakes of varIndices
          const solution = solveLinearSystem(A, b);

          let validSolution = true;
          if (solution && solution.length === m) {
            // Build new stakesReal vector
            const newStakesReal = stakesReal.slice();
            for (let u = 0; u < m; u++) {
              const i = varIndices[u];
              const val = solution[u];
              if (!isFinite(val) || isNaN(val) || val < -1e-6) {
                validSolution = false;
                break;
              }
              newStakesReal[i] = Math.max(0, val); // ensure non-negative
            }
            if (validSolution) {
              stakesReal = newStakesReal;
            }
          } else {
            validSolution = false;
          }

          // If couldn't solve or invalid (negative), fallback: distribute using inverses logic while keeping control fixed
          if (!validSolution) {
            // compute inverses but keeping ref stake fixed, scale others to use remaining totalRealRef
            // First compute total currently allocated to ref and remaining budget
            const allocatedRef = stakeRefReal;
            // We'll distribute the remainder proportionally to "inverse weights"
            const invs = [];
            let sumInv = 0;
            for (let i = 0; i < n; i++) {
              if (i === refIndex) continue;
              if (isLay[i]) {
                invs.push(odds[i] - 1);
              } else {
                invs.push(freebets[i] ? 1 / (odds[i] - 1) : 1 / odds[i]);
              }
            }
            sumInv = invs.reduce((a,b)=>a+b,0);
            let remaining = Math.max(0, totalReal - allocatedRef);
            for (let u=0; u<m; u++) {
              const i = varIndices[u];
              const stake = sumInv>0 ? (remaining * invs[u] / sumInv) : 0;
              stakesReal[i] = stake;
            }
            // keep ref stake as is
            stakesReal[refIndex] = stakeRefReal;
          }

          // write stakes back to inputs (divide by qtdContas to show per-account)
          rows.forEach((row, idx) => {
            const valPerAccount = (stakesReal[idx] / (qtdContas || 1));
            row.querySelector('.aposta-input').value = (isFinite(valPerAccount) ? valPerAccount : 0).toFixed(2);
          });

          // update totalDisplay
          let somaTotal = 0;
          rows.forEach((row, i) => {
            const val = parseFloat(row.querySelector('.aposta-input').value) || 0;
            somaTotal += val;
          });
          totalDisplay.value = somaTotal.toFixed(2);
        }
      } else {
        // No control index: normal mode (unless manualMode)
        if (state.manualMode) {
          // user edited apostas manually -> keep the manual values but update total display
          let somaTotal = 0;
          rows.forEach((row, i) => {
            const val = parseFloat(row.querySelector('.aposta-input').value) || 0;
            somaTotal += val;
            stakesReal[i] = val * qtdContas;
          });
          totalDisplay.value = somaTotal.toFixed(2);
        } else {
          // automatic distribution: use inverses
          let inversos = [];
          for (let i = 0; i < rows.length; i++) {
            if (isLay[i]) {
              inversos[i] = odds[i] - 1;
            } else {
              if (freebets[i]) {
                inversos[i] = 1 / (odds[i] - 1);
              } else {
                inversos[i] = 1 / odds[i];
              }
            }
          }
          const soma = inversos.reduce((a,b) => a + b, 0);
          if (soma > 0) {
            const stakes = inversos.map(inv => (totalReal * inv) / soma);
            stakesReal = stakes;
            rows.forEach((row, i) => {
              row.querySelector('.aposta-input').value = ( (stakesReal[i] / (qtdContas || 1)) ).toFixed(2);
            });
            // update display
            let somaTotal = 0;
            rows.forEach((row, i) => {
              somaTotal += parseFloat(row.querySelector('.aposta-input').value) || 0;
            });
            totalDisplay.value = somaTotal.toFixed(2);
          }
        }
      }

      // Recompute stakesPerAccount and scenario profits
      const apostasFinalPerAccount = [];
      for (let i = 0; i < rows.length; i++) {
        const val = parseFloat(rows[i].querySelector('.aposta-input').value) || 0;
        apostasFinalPerAccount[i] = val;
      }
      const apostasFinalReal = apostasFinalPerAccount.map(a => a * qtdContas);

      // stakeReal (sum of real stakes excluding freebets)
      let stakeReal = 0;
      for (let i = 0; i < rows.length; i++) {
        if (!freebets[i]) {
          stakeReal += apostasFinalReal[i];
        }
      }

      const scenarioProfits = calculateScenarioProfits(
        apostasFinalReal,
        odds,
        isLay,
        freebets,
        cashbacks
      );

      const minLucro = Math.min(...scenarioProfits);
      rows.forEach((row, i) => {
        row.querySelector('.lucro-output').textContent = money(scenarioProfits[i]);
      });

      $('#stakeTotal').textContent = `R$ ${money(stakeReal)}`;
      const porc = stakeReal > 0 ? ((minLucro / stakeReal) * 100).toFixed(2) : '0.00';
      $('#porcentagem').textContent = `${porc} %`;
      $('#lucroTotal').textContent = `R$ ${money(minLucro)}`;

      // show results table
      const results = $('#resultsBody');
      results.innerHTML = '';
      rows.forEach((row, i) => {
        const tr = document.createElement('tr');
        const apostaReal = apostasFinalReal[i];
        tr.innerHTML = `
          <td>${row.querySelector('.casa-input').value}</td>
          <td>${odds[i].toFixed(3)}</td>
          <td>R$ ${money(apostaReal)}</td>
          <td>${isLay[i] ? 'LAY' : (freebets[i] ? 'BACK (Freebet)' : 'BACK')}</td>
          <td class="lucro">R$ ${money(scenarioProfits[i])}</td>
        `;
        results.appendChild(tr);
      });
    }

    /* =========
       Inicialização e handlers
       ========= */
    function init() {
      updateNavbar();
      updateInputsState();

      const toggles = {
        switchFreebet: 'showFreebet',
        switchCashback: 'showCashback',
        switchComissao: 'showComissao',
        switchAumento: 'showAumento'
      };
      Object.entries(toggles).forEach(([id, key]) => {
        const el = $(`#${id}`);
        el.addEventListener('click', () => {
          if (!isLoggedIn()) return;
          el.classList.toggle('on');
          state[key] = el.classList.contains('on');
          renderTableColumns();
          updateFreebetCashbackFields();
          updateCalculations();
        });
      });

      $('#qtdCasas').addEventListener('change', () => {
        if (!isLoggedIn()) return;
        state.qtdCasas = parseInt($('#qtdCasas').value) || 2;
        renderRows();
        updateCalculations();
      });

      $('#qtdContas').addEventListener('input', () => {
        if (isLoggedIn()) updateCalculations();
      });

      $('#apostaTotalDisplay').addEventListener('input', () => {
        if (!isLoggedIn()) return;
        state.controlIndex = null;
        state.manualMode = true; // user is defining total => manual mode
        $$('.comissao-checkbox').forEach(cb => cb.checked = false);
        // recalc per-account stakes from total
        const totalDisplay = $('#apostaTotalDisplay');
        const totalValue = parseFloat(totalDisplay.value) || 0;
        const qtdContas = parseFloat($('#qtdContas').value) || 1;
        const totalReal = totalValue * qtdContas;

        // distribute proportionally (inverses) when user types a total
        const rows = $$('#apostasBody tr');
        let inversos = [];
        const odds = [], freebets = [], isLay = [];
        rows.forEach((row, i) => {
          const oddRaw = parseFloat(row.querySelector('.odd-input').value) || 2.0;
          const comissao = state.showComissao ? parseFloat(row.querySelector('.comissao-input').value) || 0 : 0;
          const aumento = state.showAumento ? parseFloat(row.querySelector('.aumento-input').value) || 0 : 0;
          const isFreebet = state.showFreebet && row.querySelector('.freebet-checkbox').checked;
          const tipoBtn = row.querySelector('.type-btn');
          const lay = tipoBtn.classList.contains('lay');
          const effOdd = getEffectiveOdd(oddRaw, comissao, aumento);
          odds[i] = effOdd;
          freebets[i] = isFreebet;
          isLay[i] = lay;
        });
        for (let i=0;i<rows.length;i++){
          if (isLay[i]) inversos[i] = odds[i]-1;
          else inversos[i] = freebets[i] ? 1/(odds[i]-1) : 1/odds[i];
        }
        const soma = inversos.reduce((a,b)=>a+b,0);
        if (soma>0){
          const stakes = inversos.map(inv => (totalReal * inv) / soma);
          rows.forEach((row,i)=>{
            row.querySelector('.aposta-input').value = (stakes[i] / (qtdContas || 1)).toFixed(2);
          });
        }
        recalculateTotalFromIndividuals();
        updateCalculations();
      });

      $('#btnCopyAposta').addEventListener('click', () => {
        if (!isLoggedIn()) return;
        navigator.clipboard.writeText($('#apostaTotalDisplay').value).then(() => {});
      });

      // wire up modal buttons
      ['btnModalLogin', 'btnModalRegister', 'btnDoAuth'].forEach(id => {
        $(`#${id}`).addEventListener('click', () => window.location.href = 'login.html');
      });

      // initial rendering
      state.qtdCasas = parseInt($('#qtdCasas').value) || 2;
      renderRows();
      if (isLoggedIn()) updateCalculations();

      // periodically refresh input enabled/disabled state to reflect login
      setInterval(updateInputsState, 800);
    }

    document.addEventListener('DOMContentLoaded', init);

    const modal = $('#modal');
    modal.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });
    $('#btnCloseModal').addEventListener('click', () => modal.style.display = 'none');

  </script>
</body>
</html>
