<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fábrica Super Odd — Calculadora</title>
  <link rel="icon" href="image/logo.png" type="image/png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #1f2b3a;
      --accent: #f3e5a6;
      --accent-strong: #e9d984;
      --muted: #6b7280;
      --card: #ffffff;
      --soft: #f5f7fa;
      --shadow: 0 6px 20px rgba(18, 24, 36, 0.06);
      --watermark-opacity: 0.04;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif
    }

    html,
    body {
      height: 100%;
      background: #f6f7fb;
      color: #111;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale
    }

    a {
      color: inherit;
      text-decoration: none
    }

    html,
    body {
      overflow: auto
    }

    * {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    *::-webkit-scrollbar {
      display: none;
      width: 0;
      height: 0;
    }

    .wrap {
      max-width: 1150px;
      margin: 28px auto;
      padding: 18px
    }

    .navbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card);
      padding: 14px 18px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      gap: 12px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .logo {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background: url('image/logo.png') center/contain no-repeat
    }

    .brand h1 {
      font-size: 16px;
      font-weight: 700;
      color: #0f1724
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .nav-actions button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer
    }

    .nav-actions .icon-btn {
      background: transparent;
      color: var(--muted);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      border: 1px solid #e6e9ee
    }

    .section {
      background: var(--card);
      border-radius: 12px;
      padding: 18px;
      margin-top: 18px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .section::before,
    .table-wrap::before,
    .results-left::before,
    .summary-card::before {
      content: '';
      position: absolute;
      right: 12px;
      bottom: 6px;
      width: 140px;
      height: 140px;
      background-image: url('image/logo.png');
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      opacity: var(--watermark-opacity);
      pointer-events: none;
      filter: grayscale(1);
      mix-blend-mode: lighten;
    }

    .table-wrap::before,
    .results-left::before {
      inset: 0;
      background-size: 200px;
      background-repeat: repeat;
    }

    h2 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #0b1720;
      background: var(--card);
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      margin-top: -6px;
      margin-left: -18px;
      margin-right: -18px;
    }

    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 8px
    }

    .grid2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 18px
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    label {
      font-size: 14px;
      color: #24303a;
      font-weight: 600
    }

    select,
    input[type="number"],
    input[type="text"] {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e6f0e9;
      background: #fff;
      outline: none
    }

    select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%), linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 12px) calc(1em + 2px), calc(100% - 7px) calc(1em + 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat
    }

    input:focus,
    select:focus {
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 6px rgba(233, 217, 132, 0.06)
    }

    .toggles {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .switch {
      position: relative;
      width: 44px;
      height: 26px;
      border-radius: 16px;
      background: #eee;
      cursor: pointer
    }

    .switch input {
      display: none
    }

    .knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      transition: all .22s
    }

    .switch.on {
      background: var(--accent-strong)
    }

    .switch.on .knob {
      transform: translateX(18px)
    }

    .toggle-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      display: block;
    }

    .table-wrap {
      margin-top: 6px;
      border-radius: 10px;
      overflow: visible;
      position: relative;
      min-width: 300px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: transparent;
      table-layout: fixed;
    }

    thead th {
      background: var(--primary);
      color: #fff;
      padding: 12px 8px;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      font-weight: 700;
      text-align: left;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 1px solid rgba(255, 255, 255, 0.06);
    }

    thead th:first-child {
      border-left: none;
    }

    tbody tr {
      background: #f6f7f9
    }

    tbody tr+tr {
      margin-top: 8px
    }

    tbody td {
      padding: 8px 6px;
      border-bottom: 1px solid rgba(16, 24, 32, 0.04);
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 13px;
    }

    /* Colunas dinâmicas */
    .col-casa {
      width: 14%
    }

    .col-tipo {
      width: 7%
    }

    .col-odd {
      width: 7%
    }

    .col-comissao {
      width: 8%
    }

    .col-oddfinal {
      width: 8%
    }

    .col-aumento {
      width: 7%
    }

    .col-aposta {
      width: 12%
    }

    .col-freebet {
      width: 9%
    }

    .col-cashback {
      width: 9%
    }

    .col-c {
      width: 8%
    }

    .col-lucro {
      width: 11%
    }

    tbody td input[type="text"],
    tbody td input[type="number"] {
      border: 1px solid #dfe7d0;
      padding: 5px 6px;
      border-radius: 5px;
      background: #fff;
      font-size: 12px;
      width: 100%;
      box-sizing: border-box;
    }

    .type-btn {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 5px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      border: none;
      width: 100%;
      text-align: center;
    }

    .type-btn.back {
      background: rgba(0, 0, 0, 0.05);
      color: #0f1724
    }

    .type-btn.lay {
      background: rgba(255, 0, 0, 0.08);
      color: #8b1f1f
    }

    .chk {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .chk input {
      display: none
    }

    .chk .chkbox {
      width: 20px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid #ddd;
      display: inline-block;
      position: relative;
      transition: all .18s;
      background: #fff;
    }

    .chk .chkbox::after {
      content: '';
      position: absolute;
      left: 5px;
      top: 0;
      width: 5px;
      height: 9px;
      border: solid #fff;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      opacity: 0;
      transition: opacity .14s;
    }

    .chk input:checked+.chkbox {
      background: var(--accent);
      border-color: var(--accent-strong);
    }

    .chk input:checked+.chkbox::after {
      opacity: 1
    }

    .col-freebet.hidden,
    .col-cashback.hidden,
    .col-comissao.hidden,
    .col-aumento.hidden {
      display: none !important;
    }

    .results-wrap {
      margin-top: 8px;
      display: flex;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .results-left {
      flex: 1 1 600px;
      min-width: 300px;
      border-radius: 10px;
      overflow: hidden;
      background: var(--card);
      border: 1px solid #e9eef0;
      position: relative;
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .results-table thead th {
      background: var(--primary);
      color: #fff;
      padding: 10px;
      font-weight: 700;
      text-align: left;
      font-size: 13px;
    }

    .results-table td {
      padding: 10px;
      border-bottom: 1px solid rgba(16, 24, 32, 0.04);
      background: #fff;
      font-size: 14px;
    }

    .results-right {
      width: 240px;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .results-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .results-actions .btn {
      width: 100%;
      display: block;
      text-align: center;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }

    .summary-card {
      background: var(--card);
      border-radius: 10px;
      padding: 14px;
      border: 1px solid #eef6f8;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .summary-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }

    .summary-card .label {
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
    }

    .summary-card .value {
      font-weight: 800;
      margin-top: 6px;
      font-size: 16px;
      color: var(--primary);
    }

    .summary-card .value.highlight {
      color: var(--accent);
    }

    .highlight {
      color: var(--accent);
      font-weight: 800
    }

    .actions {
      display: flex;
      gap: 12px;
      margin-top: 12px
    }

    .btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 700;
      cursor: pointer
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid #e6e9ee;
      color: var(--muted)
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(3, 6, 12, 0.45);
      z-index: 60;
    }

    .modal {
      width: 360px;
      background: #fff;
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(2, 6, 23, 0.35);
    }

    .modal h3 {
      margin-bottom: 10px
    }

    .modal .muted {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px
    }

    .modal .row {
      display: flex;
      gap: 8px
    }

    .modal .small {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px
    }

    .admin-box {
      margin-top: 10px;
      padding: 12px;
      border-radius: 8px;
      border: 1px dashed #e6eef0;
      background: #fbfeff
    }

    .admin-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .file-input {
      display: none
    }

    @media (max-width:768px) {
      .grid2 {
        grid-template-columns: 1fr
      }

      .wrap {
        padding: 12px
      }

      .modal {
        width: 92%
      }

      .results-wrap {
        flex-direction: column
      }

      .results-right {
        width: 100%;
        min-width: 0;
        flex-direction: row;
        gap: 8px;
        flex-wrap: wrap
      }

      .results-actions {
        flex-direction: row;
        width: 100%
      }

      .results-actions .btn {
        flex: 1
      }

      .summary-cards {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .summary-card {
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
      }

      .summary-card .value {
        font-size: 14px;
      }

      #apostasTable,
      #apostasTable thead,
      #apostasTable tbody,
      #apostasTable th,
      #apostasTable td,
      #apostasTable tr {
        display: block;
      }

      #apostasTable thead tr {
        position: absolute;
        top: -9999px;
        left: -9999px;
      }

      #apostasTable tr {
        border: 1px solid #e3e7ea;
        padding: 12px;
        margin-bottom: 12px;
        display: block;
        background: #fff;
        border-radius: 8px;
      }

      #apostasTable td {
        border: none;
        position: relative;
        padding-left: 48%;
        white-space: normal;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
      }

      #apostasTable td::before {
        content: attr(data-label) ": ";
        position: absolute;
        left: 12px;
        width: 40%;
        font-weight: 700;
        text-align: left;
        color: #24303a;
      }

      #apostasTable td input[type="text"],
      #apostasTable td input[type="number"] {
        max-width: 110px;
        width: 110px;
      }

      .type-btn {
        padding: 6px 10px;
        font-size: 13px
      }

      .chk .chkbox {
        width: 24px;
        height: 18px
      }

      tfoot td {
        display: block !important;
        text-align: right !important;
        padding: 12px !important;
      }

      .aposta-total {
        justify-content: space-between;
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .aposta-total input {
        width: 110px;
        text-align: right;
        font-size: 14px;
      }

      .results-left {
        order: 0;
        width: 100%
      }

      .results-right {
        order: 1;
        width: 100%;
        display: flex;
        gap: 8px;
        flex-wrap: wrap
      }

      .results-actions {
        width: 100%;
        display: flex;
        gap: 8px
      }

      .summary-cards {
        grid-template-columns: repeat(3, 1fr);
        width: 100%
      }

      .btn,
      .type-btn {
        touch-action: manipulation;
      }
    }

    /* align aposta total under column aposta */
    tfoot td.aposta-foot {
      padding: 8px 6px;
      text-align: left;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="navbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Fábrica Super Odd</h1>
          <div class="small">Calculadora de Arbitragem</div>
        </div>
      </div>
      <div class="nav-actions">
        <a href="#" id="btnOpenLogin" title="Entrar / Sair"
          style="background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;text-decoration:none;display:inline-block">Entrar</a>
      </div>
    </div>

    <div class="section">
      <h2>Configurações</h2>
      <div class="sub">Defina o procedimento e as opções.</div>
      <div class="grid2" style="margin-top:12px">
        <div class="field">
          <label>Procedimento</label>
          <select id="procedimento" disabled>
            <option>Arbitragem Simples</option>
            <option>Freebet</option>
            <option>Cashback</option>
          </select>
        </div>
        <div class="field">
          <label>Quantidade de casas</label>
          <select id="qtdCasas" disabled>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
        </div>
        <div class="field">
          <label>Quantidade de contas</label>
          <input id="qtdContas" type="number" min="1" value="1" disabled>
          <div class="small">Multiplica stake e lucro final</div>
        </div>
      </div>
      <div style="margin-top:14px" class="toggles">
        <div class="toggle" title="Ativa coluna 'Freebet'">
          <div id="switchFreebet" class="switch">
            <div class="knob"></div>
          </div>
          <div class="small">Usar Freebet</div>
        </div>
        <div class="toggle" title="Ativa coluna 'Cashback'">
          <div id="switchCashback" class="switch">
            <div class="knob"></div>
          </div>
          <div class="small">Usar Cashback</div>
        </div>
        <div class="toggle" title="Exibir comissão">
          <div id="switchComissao" class="switch on">
            <div class="knob"></div>
          </div>
          <div class="small">Exibir comissão</div>
        </div>
        <div class="toggle" title="Exibir aumento">
          <div id="switchAumento" class="switch">
            <div class="knob"></div>
          </div>
          <div class="small">Exibir aumento</div>
        </div>
      </div>
      <div class="toggle-note">
        • <strong>Freebet</strong>: aposta grátis.<br>
        • <strong>Cashback</strong>: recupera % em caso de perda.
      </div>
    </div>

    <div class="section">
      <h2>Linhas de Apostas</h2>
      <div class="sub">Insira odds e o sistema distribuirá automaticamente.</div>
      <div class="table-wrap">
        <table id="apostasTable" aria-label="Linhas de apostas">
          <thead>
            <tr>
              <th class="col-casa">Casa</th>
              <th class="col-tipo">Tipo</th>
              <th class="col-odd">ODD</th>
              <th class="col-comissao">Comissão %</th>
              <th class="col-oddfinal">ODD Final</th>
              <th class="col-aumento">Aumento %</th>
              <th class="col-aposta">Aposta</th>
              <th class="col-freebet">Freebet</th>
              <th class="col-cashback">Cashback %</th>
              <th class="col-c">C</th>
              <th class="col-lucro">Lucro</th>
            </tr>
          </thead>
          <tbody id="apostasBody"></tbody>
          <tfoot>
            <tr>
              <td colspan="6"></td>
              <td colspan="1" class="aposta-foot">
                <div class="aposta-total" style="display: flex; align-items: center; gap: 6px;">
                  <strong>Aposta total:</strong>
                  <input id="apostaTotalDisplay" type="number" step="0.01" value="100.00"
                    style="width: 90px; padding: 4px 6px; font-size: 12px;">
                  <button class="btn ghost" id="btnCopyAposta" disabled
                    style="padding: 4px 6px; width: auto;">📋</button>
                </div>
              </td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    <div class="section">
      <h2>Resultados</h2>
      <div class="results-wrap">
        <div class="results-left">
          <table class="results-table">
            <thead>
              <tr>
                <th>Casa</th>
                <th>ODD</th>
                <th>Aposta</th>
                <th>Tipo</th>
                <th>Lucro</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
        <div class="results-right">
          <div class="results-actions">
            <button class="btn" id="btnShare" disabled>📤 Compartilhar</button>
            <button class="btn ghost" id="btnAddPlanilha" disabled>📊 Adicionar à planilha</button>
          </div>
          <div class="summary-cards">
            <div class="summary-card">
              <div class="label">Stake Total</div>
              <div class="value highlight" id="stakeTotal">R$ 0.00</div>
            </div>
            <div class="summary-card">
              <div class="label">Porcentagem</div>
              <div class="value" id="porcentagem">0.00 %</div>
            </div>
            <div class="summary-card">
              <div class="label">Lucro (pior cenário)</div>
              <div class="value highlight" id="lucroTotal">R$ 0.00</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="adminPanel" class="section" style="display:none"></div>
  </div>

  <div id="modal" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal" role="document">
      <h3 id="modalTitle">Entrar</h3>
      <div class="muted">Use seu e-mail e senha.</div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn" id="btnModalLogin">Login</button>
        <button class="btn ghost" id="btnModalRegister">Cadastrar</button>
      </div>
      <div style="margin-top:8px"><label>Email</label><input id="authEmail" type="text" placeholder="seu@email.com">
      </div>
      <div style="margin-top:8px"><label>Senha</label><input id="authPass" type="password" placeholder="senha"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" id="btnDoAuth">Confirmar</button>
        <button class="btn ghost" id="btnCloseModal">Fechar</button>
      </div>
    </div>
  </div>

  <script>
    /* ======================================================
       FÁBRICA SUPER ODD — JS FINAL (C fix, Freebet, total sync, inputs)
       ====================================================== */

    const state = {
      qtdCasas: 2,
      showComissao: true,
      showAumento: false,
      showFreebet: false,
      showCashback: false,
      controlIndex: null,    // index da casa com "C" marcada (null = nenhum)
      manualMode: false      // true se usuário editou stakes individuais
    };

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const moneyFmt = v => "R$ " + (Number(v || 0).toFixed(2));

    // ------------------ UTILITÁRIOS ------------------
    function isLoggedIn() {
      return localStorage.getItem('superodd_logged_in') === 'true';
    }

    function updateNavbar() {
      const btn = $('#btnOpenLogin');
      if (!btn) return;
      if (isLoggedIn()) {
        btn.textContent = 'Sair';
        btn.onclick = e => { e.preventDefault(); localStorage.removeItem('superodd_logged_in'); location.reload(); };
      } else {
        btn.textContent = 'Entrar';
        btn.onclick = e => { e.preventDefault(); window.location.href = 'login.html'; };
      }
    }

    function updateInputsState() {
      const logged = isLoggedIn();
      const disable = !logged;
      [
        '#procedimento', '#qtdCasas', '#qtdContas', '#btnCopyAposta',
        '#btnShare', '#btnAddPlanilha', '#apostaTotalDisplay'
      ].forEach(sel => { const el = $(sel); if (el) el.disabled = disable; });
      $$('#apostasBody input, #apostasBody button, .chk input').forEach(el => { el.disabled = disable; });
    }

    // ------------------ ALGEBRA: Eliminação Gaussiana ------------------
    function solveLinearSystem(A, b) {
      // A: array of arrays (n x n), b: array (n)
      const n = A.length;
      if (n === 0) return [];
      // build augmented matrix
      const M = A.map((row, i) => row.concat([b[i]]));
      for (let k = 0; k < n; k++) {
        // pivot
        let i_max = k;
        let maxv = Math.abs(M[k][k]);
        for (let i = k + 1; i < n; i++) {
          const v = Math.abs(M[i][k]);
          if (v > maxv) { maxv = v; i_max = i; }
        }
        if (Math.abs(M[i_max][k]) < 1e-12) return null; // singular
        if (i_max !== k) { const tmp = M[k]; M[k] = M[i_max]; M[i_max] = tmp; }
        const pivot = M[k][k];
        for (let j = k; j <= n; j++) M[k][j] /= pivot;
        for (let i = 0; i < n; i++) {
          if (i === k) continue;
          const f = M[i][k];
          if (Math.abs(f) < 1e-14) continue;
          for (let j = k; j <= n; j++) M[i][j] -= f * M[k][j];
        }
      }
      return M.map(row => row[n]);
    }

    // ------------------ COEFICIENTES: impacto de cada stake no lucro de um cenário
    // retorna multiplicador (quanto 1 unidade de stake_i afeta lucro quando outcome=w)
    function coefForStake(i, outcome, odds, isLay, freebets, cashbacks) {
      const odd = odds[i];
      const lay = isLay[i];
      const free = freebets[i];
      const cashback = cashbacks[i] || 0;

      if (lay) {
        // LAY: se sua seleção ganha (i === outcome) -> você perde responsabilidade (-(odd-1)*stake)
        if (i === outcome) return - (odd - 1);
        // se outra seleção ganha -> seu lay ganha a stake ( +1 * stake )
        return 1;
      } else {
        // BACK:
        if (i === outcome) {
          // vence: freebet -> ganha (odd-1)*stake ; normal -> odd*stake
          return free ? (odd - 1) : odd;
        } else {
          // perde: freebet -> custo 0 ; normal -> perde stake, mas cashback devolve %
          return free ? 0 : - (1 - (cashback || 0) / 100);
        }
      }
    }

    // ------------------ Construir lucros dado stakes reais (multiplicados por qtdContas)
    function calculateScenarioProfits(apostasReal, odds, isLay, freebets, cashbacks, comissoes) {
      const n = apostasReal.length;
      const profits = new Array(n).fill(0);
      for (let w = 0; w < n; w++) {
        let lucro = 0;
        for (let i = 0; i < n; i++) {
          const stake = apostasReal[i] || 0;
          const odd = odds[i];
          const lay = isLay[i];
          const free = freebets[i];
          const cashback = cashbacks[i] || 0;

          if (lay) {
            if (i === w) {
              // perdemos a responsabilidade
              lucro -= (odd - 1) * stake;
            } else {
              // ganhamos a stake do lay
              lucro += stake;
            }
          } else {
            // BACK
            if (i === w) {
              // venceu
              lucro += free ? (odd - 1) * stake : odd * stake;
            } else {
              // perdeu
              lucro -= free ? 0 : stake * (1 - (cashback || 0) / 100);
            }
          }
        }
        // aplicar comissão sobre lucro se definido para a casa vendedora (comissão incide sobre lucro do cenário vencedor)
        if (comissoes && comissoes[w] > 0) lucro = lucro * (1 - comissoes[w] / 100);
        profits[w] = lucro;
      }
      return profits;
    }

    // ------------------ FUNÇÃO PRINCIPAL DE CÁLCULO E REGRAS
    function updateCalculations() {
      if (!isLoggedIn()) return;

      // inputs
      const totalPerAccount = parseFloat($('#apostaTotalDisplay').value.replace(',', '.')) || 0;
      const qtdContas = parseFloat($('#qtdContas').value.replace(',', '.')) || 1;
      const totalRealWanted = totalPerAccount * qtdContas;

      const rows = $$('#apostasBody tr');
      const n = rows.length;

      // arrays de parâmetros
      const odds = [], isLay = [], comissoes = [], aumentos = [], freebets = [], cashbacks = [];

      rows.forEach((row, i) => {
        const oddRaw = parseFloat((row.querySelector('.odd-input').value || '2').toString().replace(',', '.')) || 2;
        const com = state.showComissao ? parseFloat((row.querySelector('.comissao-input').value || '0').toString().replace(',', '.')) || 0 : 0;
        const aum = state.showAumento ? parseFloat((row.querySelector('.aumento-input').value || '0').toString().replace(',', '.')) || 0 : 0;
        const effOdd = Math.max(1.001, oddRaw * (1 + aum / 100) * (1 - com / 100));
        odds[i] = effOdd;
        comissoes[i] = com;
        aumentos[i] = aum;
        isLay[i] = row.querySelector('.type-btn').classList.contains('lay');
        freebets[i] = state.showFreebet && row.querySelector('.freebet-checkbox').checked;
        cashbacks[i] = state.showCashback ? parseFloat((row.querySelector('.cashback-input').value || '0').toString().replace(',', '.')) || 0 : 0;

        // update odd final UI
        const oddFinalEl = row.querySelector('.odd-final');
        if (oddFinalEl) oddFinalEl.textContent = effOdd.toFixed(3);
      });

      // --- stakes por conta (como user vê nos inputs)
      let stakesPerAccount = rows.map(row => parseFloat((row.querySelector('.aposta-input').value || '0').toString().replace(',', '.')) || 0);

      // --- Se usuário não está em manualMode e não escolheu C -> distribuir a partir do totalRealWanted
      const anyFreeCount = freebets.reduce((s, f, i) => s + (f ? 1 : 0), 0);
      const nonFreeIndices = [];
      for (let i = 0; i < n; i++) if (!freebets[i]) nonFreeIndices.push(i);

      if (!state.manualMode && state.controlIndex === null) {
        // distribuir totalRealWanted entre casas que *pagam* (não-freebet) com pesos invs
        const invs = [];
        for (let i = 0; i < n; i++) {
          if (freebets[i]) invs[i] = 0;
          else invs[i] = isLay[i] ? (odds[i] - 1) : (1 / odds[i]);
        }
        const sumInv = invs.reduce((a, b) => a + b, 0) || 1;
        // stakes reais (multiplicado por qtdContas) = totalRealWanted * inv / sumInv
        for (let i = 0; i < n; i++) {
          const stakeReal = (totalRealWanted * invs[i]) / sumInv;
          stakesPerAccount[i] = (stakeReal / (qtdContas || 1));
        }
      }

      // --- Se C está ativo -> resolver sistema linear mantendo stakeRef fixo
      if (state.controlIndex !== null) {
        const ref = state.controlIndex;
        // stakeRefReal = stakeRef_perAccount * qtdContas (pegamos o valor que está na input, como você pediu)
        let stakeRefPerAccount = parseFloat((rows[ref].querySelector('.aposta-input').value || '0').toString().replace(',', '.')) || 0;
        let stakeRefReal = stakeRefPerAccount * (qtdContas || 1);

        // se stakeRefReal == 0, vamos tentar usar uma distribuição inicial para obter base
        if (!isFinite(stakeRefReal) || stakeRefReal === 0) {
          // criar distribuição por inversos para garantir referência positiva
          const invsInit = odds.map((o, i) => isLay[i] ? (o - 1) : (1 / o));
          const sumInvInit = invsInit.reduce((a, b) => a + b, 0) || 1;
          const stakesInitReal = invsInit.map(inv => (totalRealWanted * inv) / sumInvInit);
          stakeRefReal = stakesInitReal[ref];
          // escrever como perAccount para referência visual
          rows[ref].querySelector('.aposta-input').value = (stakeRefReal / (qtdContas || 1)).toFixed(2);
          stakeRefPerAccount = stakeRefReal / (qtdContas || 1);
        }

        // Variáveis desconhecidas: stakesReal de índices != ref
        const varIdx = [];
        for (let i = 0; i < n; i++) if (i !== ref) varIdx.push(i);
        const m = varIdx.length;

        if (m === 0) {
          // somente 1 casa -> nada para resolver
        } else {
          // montar sistema A x = b
          const A = [];
          const b = [];
          // coef: para cada equação (outcome != ref) queremos lucro_outcome - lucro_ref = 0
          for (let eq_i = 0; eq_i < m; eq_i++) {
            const outcome = varIdx[eq_i];
            const rowA = new Array(m).fill(0);
            for (let var_j = 0; var_j < m; var_j++) {
              const stakeIdx = varIdx[var_j];
              const coef_j = coefForStake(stakeIdx, outcome, odds, isLay, freebets, cashbacks);
              const coef_ref = coefForStake(stakeIdx, ref, odds, isLay, freebets, cashbacks);
              rowA[var_j] = coef_j - coef_ref;
            }
            // RHS: contribuição da stakeRef (known) moved to RHS
            const coef_refStake_outcome = coefForStake(ref, outcome, odds, isLay, freebets, cashbacks);
            const coef_refStake_ref = coefForStake(ref, ref, odds, isLay, freebets, cashbacks);
            const rhs = - (coef_refStake_outcome - coef_refStake_ref) * stakeRefReal;
            A.push(rowA);
            b.push(rhs);
          }

          const sol = solveLinearSystem(A, b);
          let valid = true;
          if (sol && sol.length === m) {
            // map solution into stakesReal
            const newStakesReal = new Array(n).fill(0);
            newStakesReal[ref] = stakeRefReal;
            for (let k = 0; k < m; k++) {
              const idx = varIdx[k];
              const val = sol[k];
              if (!isFinite(val) || isNaN(val) || val < -1e-8) { valid = false; break; }
              newStakesReal[idx] = Math.max(0, val);
            }
            if (valid) {
              // ajustar escala para bater com totalRealWanted (manter proporção)
              const soma = newStakesReal.reduce((a, b) => a + b, 0) || 1;
              const scale = (totalRealWanted || soma) / soma;
              for (let i = 0; i < n; i++) newStakesReal[i] *= scale;
              // escrever de volta em per-account inputs
              for (let i = 0; i < n; i++) {
                rows[i].querySelector('.aposta-input').value = (newStakesReal[i] / (qtdContas || 1)).toFixed(2);
              }
            } else {
              // fallback: distribuir com inversos, mantendo stakeRefReal
              const invs = [];
              for (let i = 0; i < n; i++) {
                if (i === ref) continue;
                invs.push(isLay[i] ? (odds[i] - 1) : (1 / odds[i]));
              }
              const sumInv = invs.reduce((a, b) => a + b, 0) || 1;
              const remaining = Math.max(0, totalRealWanted - stakeRefReal);
              for (let u = 0; u < varIdx.length; u++) {
                const idx = varIdx[u];
                const stakeReal = remaining * invs[u] / sumInv;
                rows[idx].querySelector('.aposta-input').value = (stakeReal / (qtdContas || 1)).toFixed(2);
              }
              rows[ref].querySelector('.aposta-input').value = (stakeRefReal / (qtdContas || 1)).toFixed(2);
            }
          } else {
            // fallback: same as above
            const invs = [];
            for (let i = 0; i < n; i++) {
              if (i === ref) continue;
              invs.push(isLay[i] ? (odds[i] - 1) : (1 / odds[i]));
            }
            const sumInv = invs.reduce((a, b) => a + b, 0) || 1;
            const remaining = Math.max(0, totalRealWanted - stakeRefReal);
            for (let u = 0; u < varIdx.length; u++) {
              const idx = varIdx[u];
              const stakeReal = remaining * invs[u] / sumInv;
              rows[idx].querySelector('.aposta-input').value = (stakeReal / (qtdContas || 1)).toFixed(2);
            }
            rows[ref].querySelector('.aposta-input').value = (stakeRefReal / (qtdContas || 1)).toFixed(2);
          }
        }
        // garantir que a input do ref permaneça exatamente igual àquela que o user havia fixado (por segurança)
        rows[ref].querySelector('.aposta-input').value = (stakeRefReal / (qtdContas || 1)).toFixed(2);
      }

      // após resolver C (se aplicável) ou distribuição/edição manual, ler stakes atualizados
      stakesPerAccount = rows.map(row => parseFloat((row.querySelector('.aposta-input').value || '0').toString().replace(',', '.')) || 0);
      const stakesReal = stakesPerAccount.map(s => s * (qtdContas || 1));

      // CALCULAR stakeTotalReal (não conta freebets)
      const stakeTotalReal = stakesReal.reduce((acc, v, i) => acc + (freebets[i] ? 0 : v), 0);

      // CALCULAR lucros por cenário (usando a regra: lucro = retorno_cenario - stake_total_real)
      // usamos a função calculateScenarioProfits que já aplica comissões/cashback dentro do retorno líquido.
      const profits = calculateScenarioProfits(stakesReal, odds, isLay, freebets, cashbacks, comissoes);

      // porém a definição de lucro do seu HTML é "Resultado da casa - Stake Total" (já refletida em profits)
      // atualizar UI: coluna Lucro por linha
      rows.forEach((r, i) => {
        const el = r.querySelector('.lucro-output');
        if (el) {
          const value = (profits[i] || 0);
          el.textContent = value.toFixed(2);
          el.style.color = value >= 0 ? '#22bb33' : '#cc3333';
        }
      });

      // atualizar cards da direita
      $('#stakeTotal').textContent = moneyFmt(stakeTotalReal);
      const minProfit = Math.min(...profits);
      $('#lucroTotal').textContent = moneyFmt(minProfit);
      const perc = stakeTotalReal !== 0 ? (minProfit / stakeTotalReal) * 100 : 0;
      $('#porcentagem').textContent = perc.toFixed(2) + ' %';
    }

    // ------------------ helpers: quando usuário edita stake individual -> recalcula Aposta Total
    function recalcApostaTotalFromIndividualInputs() {
      const rows = $$('#apostasBody tr');
      let total = 0;
      rows.forEach((r, i) => {
        const isFree = state.showFreebet && r.querySelector('.freebet-checkbox').checked;
        const val = parseFloat((r.querySelector('.aposta-input').value || '0').toString().replace(',', '.')) || 0;
        if (!isFree) total += val;
      });
      $('#apostaTotalDisplay').value = total.toFixed(2);
    }

    // ------------------ Quando usuário altera ApostaTotal -> distribuir automaticamente
    function distributeTotalToStakes() {
      const totalPerAccount = parseFloat($('#apostaTotalDisplay').value.replace(',', '.')) || 0;
      const qtdContas = parseFloat($('#qtdContas').value.replace(',', '.')) || 1;
      const totalReal = totalPerAccount * (qtdContas || 1);

      const rows = $$('#apostasBody tr');
      const n = rows.length;

      // recomputar odds/lay/free
      const odds = [], isLay = [], freebets = [];
      rows.forEach((row, i) => {
        const oddRaw = parseFloat((row.querySelector('.odd-input').value || '2').toString().replace(',', '.')) || 2;
        const com = state.showComissao ? parseFloat((row.querySelector('.comissao-input').value || '0').toString().replace(',', '.')) || 0 : 0;
        const aum = state.showAumento ? parseFloat((row.querySelector('.aumento-input').value || '0').toString().replace(',', '.')) || 0 : 0;
        const effOdd = Math.max(1.001, oddRaw * (1 + aum / 100) * (1 - com / 100));
        odds[i] = effOdd;
        isLay[i] = row.querySelector('.type-btn').classList.contains('lay');
        freebets[i] = state.showFreebet && row.querySelector('.freebet-checkbox').checked;
      });

      // pesos (invs) apenas para casas pagas
      const invs = odds.map((o, i) => freebets[i] ? 0 : (isLay[i] ? (o - 1) : (1 / o)));
      const sumInv = invs.reduce((a, b) => a + b, 0) || 1;

      for (let i = 0; i < n; i++) {
        const stakeReal = (totalReal * invs[i]) / sumInv;
        rows[i].querySelector('.aposta-input').value = (stakeReal / (qtdContas || 1)).toFixed(2);
      }
    }

    // ------------------ Criação de linhas + behavior de inputs (melhoria UX)
    function createRow(i) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
    <td class="col-casa"><input class="casa-input" type="text" value="Casa ${i + 1}" inputmode="text"></td>
    <td class="col-tipo"><button class="type-btn back">BACK</button></td>
    <td class="col-odd"><input class="odd-input" type="text" inputmode="decimal" value="2.000"></td>
    <td class="col-comissao"><input class="comissao-input" type="text" inputmode="decimal" value="0.00"></td>
    <td class="col-oddfinal"><span class="odd-final">2.000</span></td>
    <td class="col-aumento"><input class="aumento-input" type="text" inputmode="decimal" value="0.00"></td>
    <td class="col-aposta"><input class="aposta-input" type="text" inputmode="decimal" value="0.00"></td>
    <td class="col-freebet"><label class="chk"><input class="freebet-checkbox" type="checkbox"><span class="chkbox"></span></label></td>
    <td class="col-cashback"><input class="cashback-input" type="text" inputmode="decimal" value="0.00"></td>
    <td class="col-c"><label class="chk"><input class="comissao-checkbox" type="checkbox"><span class="chkbox"></span></label></td>
    <td class="col-lucro"><span class="lucro-output">0.00</span></td>
  `;

      // foco: selecionar todo, trocar vírgula por ponto automaticamente
      tr.querySelectorAll('input[type="text"]').forEach(inp => {
        inp.addEventListener('focus', () => { try { inp.select(); } catch (e) { } });
        inp.addEventListener('input', () => {
          // trocar vírgula por ponto para facilitar digitação
          if (inp.value.includes(',')) inp.value = inp.value.replace(/,/g, '.');
        });
      });

      // toggle back/lay
      const tb = tr.querySelector('.type-btn');
      tb.addEventListener('click', (e) => {
        if (!isLoggedIn()) return;
        tb.classList.toggle('lay');
        tb.classList.toggle('back');
        tb.textContent = tb.classList.contains('lay') ? 'LAY' : 'BACK';
        // se alterou tipo, recalcular (pode mudar distribuição)
        if (!state.manualMode) distributeTotalToStakes();
        updateCalculations();
      });

      // listeners importantes
      // a) quando user digita stake individual -> manualMode true, atualiza aposta total
      const stakeInput = tr.querySelector('.aposta-input');
      stakeInput.addEventListener('input', () => {
        if (!isLoggedIn()) return;
        // permitir vírgula -> trocar para ponto
        if (stakeInput.value.includes(',')) stakeInput.value = stakeInput.value.replace(/,/g, '.');
        state.manualMode = true;
        state.controlIndex = null;
        // desmarca C's
        $$('.comissao-checkbox').forEach(x => x.checked = false);
        recalcApostaTotalFromIndividualInputs();
        updateCalculations();
      });

      // b) mudanças em odds/comissao/aumento/cashback/freebet
      ['.odd-input', '.comissao-input', '.aumento-input', '.cashback-input'].forEach(sel => {
        const el = tr.querySelector(sel);
        if (!el) return;
        el.addEventListener('input', () => {
          if (!isLoggedIn()) return;
          if (el.value.includes(',')) el.value = el.value.replace(/,/g, '.');
          // se não estiver em manualMode, redeploy distribuição
          if (!state.manualMode) distributeTotalToStakes();
          updateCalculations();
        });
      });

      // c) freebet checkbox
      const freebox = tr.querySelector('.freebet-checkbox');
      freebox.addEventListener('change', () => {
        if (!isLoggedIn()) return;
        // quando freebet toggle, recalcula aposta total (já que freebet exclui do custo)
        recalcApostaTotalFromIndividualInputs();
        // se não manualMode e total foi alterado, redistribuir
        if (!state.manualMode) distributeTotalToStakes();
        updateCalculations();
      });

      // d) controle "C"
      const cbox = tr.querySelector('.comissao-checkbox');
      cbox.addEventListener('change', () => {
        if (!isLoggedIn()) return;
        $$('.comissao-checkbox').forEach(x => { if (x !== cbox) x.checked = false; });
        state.controlIndex = cbox.checked ? [...$('#apostasBody').children].indexOf(tr) : null;
        state.manualMode = false; // desativa manual mode ao escolher C
        // manter stake da casa marcada intacta (já está), e recalcular as outras
        updateCalculations();
      });

      return tr;
    }

    // ------------------ render rows & columns
    function renderRows() {
      const tbody = $('#apostasBody');
      tbody.innerHTML = '';
      for (let i = 0; i < state.qtdCasas; i++) tbody.appendChild(createRow(i));
      renderTableColumns();
      updateInputsState();
    }

    function renderTableColumns() {
      const map = {
        '.col-freebet': state.showFreebet,
        '.col-cashback': state.showCashback,
        '.col-comissao': state.showComissao,
        '.col-aumento': state.showAumento
      };
      Object.entries(map).forEach(([sel, visible]) => {
        $$(sel).forEach(el => el.classList.toggle('hidden', !visible));
      });
    }

    // ------------------ Inicialização
    function init() {
      updateNavbar();
      updateInputsState();

      // toggles
      ['switchFreebet', 'switchCashback', 'switchComissao', 'switchAumento'].forEach(id => {
        const el = $('#' + id);
        if (!el) return;
        const key = {
          switchFreebet: 'showFreebet',
          switchCashback: 'showCashback',
          switchComissao: 'showComissao',
          switchAumento: 'showAumento'
        }[id];
        el.addEventListener('click', () => {
          if (!isLoggedIn()) return;
          el.classList.toggle('on');
          state[key] = el.classList.contains('on');
          // quando showFreebet muda, recalc total and distribution
          if (!state.manualMode) {
            distributeTotalToStakes();
          } else {
            // se em manual mode, apenas recalcular total (pois freebet muda stakeTotal)
            recalcApostaTotalFromIndividualInputs();
          }
          renderTableColumns();
          updateCalculations();
        });
      });

      $('#qtdCasas').addEventListener('change', () => {
        if (!isLoggedIn()) return;
        state.qtdCasas = parseInt($('#qtdCasas').value) || 2;
        renderRows();
        if (!state.manualMode) distributeTotalToStakes();
        updateCalculations();
      });

      $('#qtdContas').addEventListener('input', () => {
        if (!isLoggedIn()) return;
        // multiplicador alterado -> recalcular tudo
        updateCalculations();
      });

      // quando editar aposta total -> distribuir automaticamente entre casas pagas
      $('#apostaTotalDisplay').addEventListener('input', () => {
        if (!isLoggedIn()) return;
        // permitir vírgula
        const el = $('#apostaTotalDisplay');
        if (el.value.includes(',')) el.value = el.value.replace(/,/g, '.');
        // ao editar total, considerar que user quer redistribuir
        state.manualMode = false;
        state.controlIndex = null;
        distributeTotalToStakes();
        updateCalculations();
      });

      $('#btnCopyAposta')?.addEventListener('click', () => {
        if (!isLoggedIn()) return;
        navigator.clipboard.writeText($('#apostaTotalDisplay').value);
      });

      renderRows();
      // set default distribuição inicial
      if (!state.manualMode) distributeTotalToStakes();
      if (isLoggedIn()) updateCalculations();

      // keep input state updated in background (login/logout)
      setInterval(updateInputsState, 800);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>




</body>

</html>